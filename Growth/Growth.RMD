---
title: "Growth"
author: "Sarah Speroff"
date: "1/06/2022"
output: html_document
---

###################################################################################################################################
#
#                                                           Setup
#
###################################################################################################################################

```{r, message=FALSE}
# Libraries
library(Rmisc)
library(ggplot2)
library(dplyr)
library(tidyr)
library(broom)
```

```{r, message=FALSE}
# WD
setwd("/Users/speroffs/Desktop/A.Poculata-Multiple-stressors-thesis-analysis-/Growth")
```

###################################################################################################################################
#
#                                                          Degree of change in Mass 
#                                                          to rank treatment effect
#
###################################################################################################################################

```{r}
#Load data
mass.dat <- read.csv("Full_ ID Metadata - *Frag metadata (xrack&control).csv", header = TRUE)
```

```{r}
# Inspect
names(mass.dat)
head(mass.dat)
summary(mass.dat)
str(mass.dat)
nrow(mass.dat)
length(unique(mass.dat$B.TAG)) # should be 480 
table(mass.dat$Sym.State) #should be even split
```

```{r}
# Subset new DF
# select rows to bring into new df

# LONG FORMAT
data <- subset(mass.dat, select = c("B.TAG", "Sym.State","Treat.ID", "Temperature", "Plastic", "Light", "Food",
                                    "Initial.Mass..g.", "Final.Mass..g.", "Days.In.Treatment"))
# change column names 
names(data)[names(data) == "Initial.Mass..g."] <- "Initial" 
names(data)[names(data) == "Final.Mass..g."] <- "Final" 
names(data)[names(data) == "Days.In.Treatment"] <- "Time" 
names(data)[names(data) == "Treat.ID"] <- "Treatment" 
```

```{r}
# relevel to compare all to control 
data$Treatment <- factor(data$Treatment, levels = c("control", "PDS", "PLS", "NDS", "NLS", "PDF", "PLF", "NDF", "NLF"))

# filter out NAs 
data <- data[complete.cases(data),]
```

#################
#
#   Calculate average change in mass from 
#   initial to final weight normalizing 
#   for time (for all polyps)  
#
#################

```{r}
# Calculate the change in mass over time in a new column

data$Change = ((data$Final - data$Initial))*1000/data$Time # converting initial and final g to mg and normalizing to time
data$Change <- round(data$Change, 3) # round to 3 decimal places
# MG / DAY
```

```{r}
# Summarize the change in mass by treatment and sym state
state_means <- summarySE(data, measurevar="Change", groupvars=c("Treatment","Sym.State")) 
```

```{r}
# Plot it 
ggplot(state_means, aes(Change, Treatment, col=Sym.State)) +
  geom_point() +
  geom_vline(xintercept = 0, col="grey", lty=1) + 
  geom_vline(xintercept = -0.83430380, col="tan", lty=2) +
  geom_vline(xintercept = -0.69474359, col="black", lty=2) +
  geom_segment(aes(xend=0, yend=Treatment)) +
  labs(x = "Net Change Mass (mg*day"^"-1"~")", y = "Treatment",
       color = "") +
  theme(panel.border = element_rect(colour = "black", fill = NA, size = 1)) +
  scale_color_manual(name = "Phenotype",
                     labels = c("Apo", "Sym"),
                     values = c("tan","coral4")) +
  theme_classic()
```

```{r}
# Let's look at change in mass not separate by sym state

# Summarise
all_means <- summarySE(data, measurevar="Change", groupvars=c("Treatment")) 
all_means
```

```{r}
# Pairwise test
# Linear model to compare the means net change in growth 
change.test <- lm(Change~Treatment, data=data)

library(emmeans)
lsmeans(change.test, pairwise ~ Treatment, adjust="tukey")
```

```{r}
#and plot
ggplot(all_means, aes(Change, Treatment, col = Treatment)) +
  geom_segment(aes(xend=0, yend=Treatment, size = 2)) +
  geom_vline(xintercept = -0.7649045, col="black", lty=2) +
  labs(x = "Net Change Mass (mg*day"^"-1"~")", y = "Treatment",
       color = "") +
  theme(panel.border = element_rect(colour = "black", fill = NA, size = 1)) +
  scale_x_continuous(breaks=seq(0, -3, by = -0.5)) +
  scale_color_manual(name = "", values = c("#131513", "#E02D00", "#FF7E33", 
                                                   "#D6A70A", "#ECDD09", "#075F3C", 
                                                   "#7BB12F", "#35516E", "#3F88C5")) +
  theme_classic()
```

###################################################################################################################################
#
#                                                          "Exponential Decay" in Mass over time 
#                                                            at each time point (0, 8, 15, 22)
#
###################################################################################################################################

```{r}
# load data
decaydat <- read.csv("growth - growthtime.csv")
```
```{r}
# change column names 
names(decaydat)[names(decaydat) == "Treat.ID"] <- "Treatment" 
```
```{r}
# change type 
decaydat$Day <- as.numeric(decaydat$Day)
```
```{r}
# relevel
decaydat$Treatment <- factor(decaydat$Treatment, levels = c("Control", "PDS", "PLS", "NDS", "NLS", "PDF", "PLF", "NDF", "NLF"))
```
```{r}
# remove NAs
decaydat <- decaydat[complete.cases(decaydat),]
```
```{r}
# Convert to mg
decaydat$Massmg <- decaydat$Mass*1000
```

```{r}
# summarize the mass at each interval by treatment and sym state
decay_means <- summarySE(decaydat, measurevar = "Massmg", groupvars = c("Treatment", "Day", "Sym.State"))
```
```{r}
# plot 
ggplot(decay_means, aes(Day, Massmg, color = Sym.State)) +
  geom_point() +
  geom_line(aes(group=Sym.State)) +
  facet_wrap(vars(Treatment)) +
  geom_errorbar(aes(ymax = Massmg+se, ymin = Massmg-se), width = .1) +
  ylab("Mass (mg)")+
  xlab("Day") +
  scale_color_manual(name = "Phenotype",
                     labels = c("Apo", "Sym"),
                     values = c("tan","coral4")) +
  scale_x_continuous(breaks=seq(1, 22, by = 7)) + # change x axis intervals 
  theme(panel.border = element_rect(colour = "black", fill = NA, size = 1)) +
  theme_classic()

### THE WEIGHT ITSELF IS NOT IMPORTANT - THE CHANGE IN MASS OVER TIME IS 
```

#################
#
#   Check the data for normality   
#
#################

```{r}
# Histogram and Quantiles
par(mfrow=c(1,2))
hist(decaydat$Massmg, main="Mass(mg)")
qqnorm(decaydat$Massmg, main="Mass (mg)")
qqline(decaydat$Massmg) # not a great fit, seems more like an exponential fit
```

```{r}
# run a simple lm to see if treatment affects mass
mass.lm <- lm(Massmg~Treatment, data=decaydat)
summary(mass.lm)
```

```{r}
# now plot it
par(mfrow=c(2,2))
plot(mass.lm)
```

```{r}
# Log-transform
decaydat$Logmassmg = log(decaydat$Massmg) #new column with the log mass in grams

par(mfrow=c(1,2))
hist(decaydat$Logmassmg, main="Log Mass (mg)")
qqnorm(decaydat$Logmassmg, main="Log Mass (mg)")
qqline(decaydat$Logmassmg) # a much better histogram and quantiles! 
```

```{r}
# run a simple lm to see if treatment has an affect on the logmass
logmassmg.lm <- lm(Logmassmg~Treatment, data=decaydat)
summary(logmassmg.lm)
```

```{r}
# plot it
par(mfrow=c(2,2))
plot(logmassmg.lm) 
```     

#################
#
#  Summarize Log(Mass) mg / day data   
#
#################    

```{r}
# summarize the LOGmass at each interval by treatment 
logmg_means <- summarySE(decaydat, measurevar = "Logmassmg", groupvars = c("Treatment", "Day"))
```

```{r}
# plot

ggplot(logmg_means, aes(Day, Logmassmg, color = Treatment)) +
  geom_point() +
  geom_smooth(aes(group=Treatment), method="lm", se=FALSE) +
  #facet_wrap(vars(Treatment)) +
  geom_errorbar(aes(ymax = Logmassmg+se, ymin = Logmassmg-se), width = .1) +
  ylab("Log(mass)(mg)")+
  xlab("Day") +
  scale_color_manual(name = "",values = c("#131513", "#E02D00", "#FF7E33", 
                                                   "#D6A70A", "#ECDD09", "#075F3C", 
                                                   "#7BB12F", "#35516E", "#3F88C5")) +
  scale_x_continuous(breaks=seq(1, 22, by = 7)) + # change x axis intervals 
  theme(panel.border = element_rect(colour = "black", fill = NA, size = 1)) +
  theme_classic()


# SLOPE FOR EACH TREATMENT !
# based on the lm(Logmass~Day)
```

```{r}
# plot raw data points with summary data 

ggplot(NULL, aes(Day, Logmassmg, color = Treatment)) +
  geom_jitter(data = decaydat, width=0.8, alpha=0.8) + # raw data
  geom_point(data = logmg_means, color = "black", size = 1.2) + # summary means 
  geom_errorbar(data = logmg_means, aes(ymin=Logmassmg-sd, ymax=Logmassmg+sd), # SEM error bars
                width=1, position=position_dodge(0.05), color = "black", size = 1.2) +
  stat_smooth(data = logmg_means, aes(group=Treatment), method="lm", se=FALSE, color = "black") + # add lm 
  facet_wrap(vars(Treatment)) +
  ylab("Log(mass)(mg)")+
  xlab("Day") +
  scale_color_manual(name = "",values = c("#808080", "#E02D00", "#FF7E33", 
                     "#D6A70A", "#ECDD09", "#075F3C", 
                     "#7BB12F", "#35516E", "#3F88C5")) +
  scale_x_continuous(breaks=seq(1, 22, by = 7)) + # change x axis intervals 
  theme_classic()

```

###################################################################################################################################
#
#                                                  Growth Rate (mg) over time (days) by treatment
#
###################################################################################################################################

```{r}
# Run simple LM for the change in log(mass) over time by each Treatment 

# create grouping factor
by_treat <- group_by(decaydat, Treatment)
```
```{r}
# Create a df with the parameter coefficients of every treatment Linear model 
treat.tidy <- 
  do(by_treat, 
   tidy(                     
     lm(Logmassmg~Day, data= .)))
treat.tidy
```

```{r}
# compare estimates to confirm they match above
ctrl.data <- filter(decaydat, Treatment == "Control")
ctrl.data

control.lm <- lm(Logmassmg ~ Day, data = ctrl.data)
summary(control.lm)
```


###################################################################################################################################
#
#                                                        Growth Rate (mg) over time (day) by 
#                                                          POLPY ID for statistical testing 
#                                                                and mixed modelling
#
###################################################################################################################################

```{r}
# Run simple LM for the change in log(mass) over time by each individual 

# create grouping factor
by_ID <- group_by(decaydat, B.TAG)
```
```{r}
# Create a df with the parameter coefficients of every treatment Linear model 
ID.slope <- 
  do(by_ID, 
   tidy(                     
     lm(Logmassmg~Day, data= .)))
ID.slope

# keep the intercept term 
ID.slope <- filter(ID.slope, term == "Day")
#rename the estimate 
names(ID.slope)[names(ID.slope) == "estimate"] <- "Slope"
```

```{r}
# Add treatment and sym.state values to ID.test dataframe by BTag

# Select variables from original data to keep
decaydat2 <- decaydat %>%
  select(Colony, Sym.State, B.TAG, Treatment, Plastic, Temperature, Food, Light) 

# add variables to new df based on ID
ID.slope <- left_join(decaydat2, ID.slope, by = "B.TAG")

# Remove NAs
#ID.slope <- ID.slope[complete.cases(ID.slope),]
```

```{r}
# Inspect ID.slope DF
str(ID.slope)

ID.slope$Colony <- as.factor(ID.slope$Colony)
ID.slope$Sym.State <- as.factor(ID.slope$Sym.State)
ID.slope$Plastic <- as.factor(ID.slope$Plastic)
ID.slope$Temperature <- as.factor(ID.slope$Temperature)
ID.slope$Food <- as.factor(ID.slope$Food)
ID.slope$Light <- as.factor(ID.slope$Light)
ID.slope$B.TAG <- as.factor(ID.slope$B.TAG)

library(tidyverse)
#remove duplicates (should be 1 value per ID)
duplicated(ID.slope)
ID.slope = ID.slope %>% 
  unique() # should be 480
```


#### HERE X
```{r}
# Recenter and rescale slope

# install.packages("devtools")
# devtools::install_github("poissonconsulting/rescale")
library(rescale)

# centered: slope-mean(slope)
#scaled: / standard deviation 
ID.slope <- rescale(ID.slope, center="Slope", scale="Slope")

# change NANs
ID.slope <- ID.slope %>%
  mutate_all(~replace(., is.nan(.), 0)) 
```
#### HERE  X ^

#####################
#
#     LSMeans slopes      
#
#####################

```{r}
# Linear model to compare the means of the growth rate for all treatments
slope.anova <- lm(Slope~Treatment, data=ID.slope)

# compare growth rate between treatments
library(emmeans)
lsmeans(slope.anova, pairwise ~ Treatment, adjust="tukey")
```

###################################################################################################################################
#
#                                                  Affect of individual Stressors on polyp growth rate
#
###################################################################################################################################


#####################
#
#     Temperature      
#
#####################

```{r}
# LM for the effect of Temp on growth rate (ie slope) [log(mass)mg/day]
temp.lm <- lm(Slope~Temperature, data=ID.slope)
summary(temp.lm)

# extract equation from lm
#temp.coef <- coef(temp.lm)
#temp_eq <- paste("y=",
#                 coef(temp.lm)[[2]],
#                      "*X","+",
#                      coef(temp.lm)[[1]])
#print(temp_eq)
```

```{r}
# Plot

ggplot(decaydat, aes(Day, Logmassmg, col=Temperature)) +
  geom_jitter(width=0.5, alpha=0.9) + 
  #facet_wrap(vars(Temperature)) +
  ggtitle("Temperature") +
  labs(x = "Day", y = "Log (mass(mg))") +
  geom_smooth(method = "lm") +
   scale_x_continuous(breaks=seq(1, 22, by = 7)) + # change x axis intervals 
  scale_color_manual(name = "",
                     labels = c("Ambient", "Elevated"),
                     values = c("royalblue","red")) +
theme_classic()
```

#################
#
#  Plastic 
#
#################    

```{r}
# LM for the effect of Temp on growth rate (ie slope) [log(mass)mg/day] 
plastic.lm <- lm(Slope~Plastic, data=ID.slope)
summary(plastic.lm)
```

```{r}
# Plot
ggplot(decaydat, aes(Day, Logmassmg, col=Plastic)) +
  geom_jitter(width=0.5, alpha=0.9) + 
  #facet_wrap(vars(Plastic)) +
  ggtitle("Plastic") +
  labs(x = "Day", y = "Log (mass(mg))") +
  geom_smooth(method = "lm") +
  scale_x_continuous(breaks=seq(1, 22, by = 7)) + # change x axis intervals 
  scale_color_manual(name = "",
                     labels = c("No Plastic", "Plastic"),
                     values = c("slategray","darkgreen")) +
theme_classic()
```

#####################
#
#       Light      
#
#####################

```{r}
# LM for the effect of Light on growth rate (ie slope) [log(mass)mg/day]  
light.lm <- lm(Slope~Light, data=ID.slope)
summary(light.lm)
```

```{r}
# Plot

ggplot(decaydat, aes(Day, Logmassmg, col=Light)) +
  geom_jitter(width=0.5, alpha=0.9) + 
  #facet_wrap(vars(Light)) +
  ggtitle("Light") +
  labs(x = "Day", y = "Log (mass(mg))") +
  geom_smooth(method = "lm") +
  scale_x_continuous(breaks=seq(1, 22, by = 7)) + # change x axis intervals 
  scale_color_manual(name = "",
                     labels = c("Dark", "Light"),
                     values = c("gray","goldenrod")) +
theme_classic()
```

#####################
#
#       Food      
#
#####################

```{r}
# LM for the effect of Light on growth rate (ie slope) [log(mass)mg/day] 
food.lm <- lm(Slope~Food, data=ID.slope)
summary(food.lm)
```

```{r}
# Plot
ggplot(decaydat, aes(Day, Logmassmg, col=Food)) +
  geom_jitter(width=0.5, alpha=0.9) + 
 # facet_wrap(vars(Food)) +
  ggtitle("Food") +
  labs(x = "Day", y = "Log (mass(mg))") +
  geom_smooth(method = "lm") +
  scale_x_continuous(breaks=seq(1, 22, by = 7)) + # change x axis intervals 
  scale_color_manual(name = "",
                     labels = c("Fed", "Starved"),
                     values = c("salmon","gray")) +
theme_classic()
```

#####################
#
#       Sym State      
#
#####################

```{r}
# LM for the effect of Light on growth rate (ie slope) [log(mass)mg/day] 
state.lm <- lm(Slope~Sym.State, data=ID.slope)
summary(state.lm)
```

```{r}
# Plot
ggplot(decaydat, aes(Day, Logmassmg, col=Sym.State)) +
  geom_jitter(width=0.5, alpha=0.9) + 
  #facet_wrap(vars(Sym.State)) +
  ggtitle("Phenotype") +
  labs(x = "Day", y = "Log (mass(mg))") +
  geom_smooth(method = "lm") +
  scale_x_continuous(breaks=seq(1, 22, by = 7)) + # change x axis intervals 
  scale_color_manual(name = "",
                     labels = c("Apo", "Sym"),
                     values = c("tan","coral4")) +
theme_classic()
```

###################################################################################################################################
#
#                                                     Affect of all stressors on growth rate
#                                                                  Mixed Models
#
###################################################################################################################################

```{r}
library(lme4)
library(lmerTest)

# Null model 
m0 <- lmer(Slope ~ 1 + (1|Colony), data=ID.slope)
summary(m0)
```

```{r}
# Full model
m1 <- lmer(Slope ~ Temperature + Plastic + Light + Food + (1|Colony), data = ID.slope)
summary(m1)

# 
m2 <- lmer(Slope ~ Temperature + Plastic + Light + Food + Sym.State + (1|Colony), data = ID.slope) # **** 
summary(m2)
```




```{r}
# Reduced model: - plastic
m2 <- lmer(Slope ~ Temperature + Light + Food + (1|Colony), data=ID.slope)
summary(m2)
```






```{r}
library(performance)

# Check model 
check_collinearity(m2) # good
check_outliers(m2) # good
check_heteroscedasticity(m2) # not good
check_homogeneity(m2) #not good
check_model(m2)
```

```{r}
# use decay dat for lmer 

decaylm <- lmer(Massmg ~ Plastic + Light + Food + Temperature + Day + (1+Day|B.TAG), data = decaydat)
summary(decaylm)
str(decaydat)
str(ID.slope)
```

