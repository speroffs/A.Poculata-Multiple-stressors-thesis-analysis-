---
title: "MM Respiration.RMD"
author: "Sarah Speroff"
date: "2/11/2022"
output: html_document
---

######################################################################################################
#
#                                               Data prep
#
######################################################################################################


```{r, include=FALSE}
# Libraries 
library(ggplot2)
library(Rmisc)
library(dplyr)
library(broom)
library(tidyr)
library(lme4)
library(lmerTest)
library(emmeans)
library(e1071)
library(ggpubr)

library(superb)
library(ggsignif)
```

```{r}
# Working Directory 
setwd("/Users/speroffs/Desktop/A.Poculata-Multiple-stressors-thesis-analysis-/Respiration")

# load the data 
data <- read.csv("Respiration Data compiled - allrates.csv", header = TRUE)
```
```{r}
# Rename column headers
names(data)[names(data) == "mass.specific"] <- "rate"

# absolute value rate for better visualization
data$rate = abs(data$rate)

# Change column variable type 
data$B.TAG=as.factor(data$B.TAG)
data$Day = as.factor(data$Day)
data$Sym.state = as.factor(data$Sym.state)
data$Bacteria = as.factor(data$Bacteria)
data$Plastic = as.factor(data$Plastic)
data$Light = as.factor(data$Light)
data$Food = as.factor(data$Food)
data$Temperature = as.factor(data$Temperature)

# Re-level treatments 
data$Treatment <- factor(data$Treatment, levels = c("Control", "PDS", "PLS", "NDS", "NLS", "PDF", "PLF", "NDF", "NLF"))

# Re-order days
#data$Day <- factor(data$Day, levels = c("8", "15", "22"))
```

#####################################################################################################################
#
#                                                Normality testing and transformations 
#
#####################################################################################################################

```{r}
# Plot the distribution of respiration rate data
par(mfrow=c(1,2))
hist(data$rate)
qqnorm(data$rate)
qqline(data$rate) # definite right skew, quantiles almost look exponential 
```
```{r}
# check the degree of skew
skewness(data$rate) # serious right skew
```

```{r}
# Let's try a log transform
data$Lograte = log(data$rate)

par(mfrow=c(1,2))
hist(data$Lograte)
qqnorm(data$Lograte)
qqline(data$Lograte) 

skewness(data$Lograte) # Lot's better, just under a moderate skew ( > 0.5) 
```
```{r}
# Let's square root transform 
data$SQrate = sqrt(data$rate)

par(mfrow=c(1,2))
hist(data$SQrate)
qqnorm(data$SQrate)
qqline(data$SQrate) 

skewness(data$SQrate) # did not improve much
```
```{r}
# let's try the last option, cube root, to see if that is best 
data$cuberate = (data$rate^1/3)

par(mfrow=c(1,2))
hist(data$cuberate)
qqnorm(data$cuberate)
qqline(data$cuberate) 

skewness(data$cuberate) # definitely not the best value here
```

## It looks like our metabolic rate data could benefit from being log-transformed 
## We'll use the log-transformed MR for modelling and statistical testing, and the untransformed MR for plotting and data reporting

#####################################################################################################################
#
#                                                Exploratory plots
#
#####################################################################################################################

```{r}
# Let's look at the rate of O2 consumption in EC vs SW for all treatments 
explore.sum <- summarySE(data, measurevar = "rate", groupvars = c("Treatment", "Day", "Bacteria"))
```
```{r}
# plot
resp.alltreat.plot <-
ggplot(explore.sum,
       aes(x = Day,
           y = rate,
           col = Treatment,
           group = Treatment)) +
  geom_point(size=1.5) +
  geom_line(size=1.2) +
  geom_errorbar(aes(ymin=rate-se, ymax=rate+se), width=0.2, size = 1.2, lty = 1) +
  
   scale_y_continuous(name = expression(paste("Rate O2 Consumption (umol min"^"-1"~"g"^"-1"~")")),
                      limits = c(0, 0.08), breaks=seq(0.0, 0.08, by = 0.01)) +
  scale_color_manual(name = "", 
                     values = c("#131513","#F53100", "#FF8B47","#C39809",
                                "#F6CB3C","#0B8454","#7BB12F","#3F88C5","#A33461")) +
  
  facet_wrap(vars(Bacteria)) +
  theme_classic(base_size=16) +
  theme(legend.position = "right",
        legend.title = element_blank(),
        legend.text = element_text(size = 12))

resp.alltreat.plot
```
```{r}
# save plot
ggsave(plot = resp.alltreat.plot,
       filename = "/Users/speroffs/Desktop/A.Poculata-Multiple-stressors-thesis-analysis-/Respiration/Figures/alltreat.EC.SW.jpg", 
       width = 8, height = 6, units = "in", dpi = 300)
```

###########################################################################################################################
#
#                           Question 1. Do astrangia respond to e.coli in every treatment / 
#                                  What is the effect of bacteria on metabolic rate?
#
###########################################################################################################################

```{r}
# Separate ambient control from experimental treatments
ctrl.data <- filter(data, Treatment == "Control")

# Run lm model (one obs per ID)
ctrl.lm1 <- lm(Lograte~Bacteria, data = ctrl.data) 
summary(ctrl.lm1) # summarize lm 

# tukey posthoc
ctrl.aov1 <- aov(Lograte~Bacteria, data = ctrl.data)
ctrl.tukey1 <- TukeyHSD(ctrl.aov1)
ctrl.tukey1
```

```{r}
# Summarize the means within our controls
ctrl.means <- summarySE(ctrl.data, measurevar = "rate", groupvars = "Bacteria")

# Plot
ctrl.resp.A <-
  ggplot(data = ctrl.means, 
       aes(x = Bacteria,
           y = rate,
           color = Bacteria)) +
  geom_point(size = 2) +
  geom_errorbar(aes(ymin=rate-se, ymax=rate+se), width=0.1, size = 1.2) +
  
  scale_color_manual(labels = c("", ""), values = c("black", "gray47")) +
  scale_x_discrete(name = "", limits = c("EC", "SW"), labels = c("Acute", "Basal")) +
  scale_y_continuous(limits = c(0.01, 0.074), breaks = seq(0.01, 0.075, by = 0.015)) +
    ylab(bquote(Metabolic~Rate~(mu~mol ~O[2]~ min^-1~g^-1))) +
  ggtitle("A") +

  theme_classic(base_size = 12) +
  theme(legend.position = "none",
        legend.title = element_blank(),
        axis.title.y = element_text(size = 12, face = "bold"),
        plot.title = element_text(vjust = 1.1, size = 18, face="bold"))
ctrl.resp.A
```

```{r}
## REFORMAT ABOVE FIGURE FOR PUBLICATION
ambient.control.plot.A<-
  ggplot() +
  geom_boxplot(data = ctrl.data,aes(x = Bacteria, y = rate, fill = Bacteria), 
               width =0.8, 
               outlier.shape = NA,
               lwd = 0.5, 
               color = "black") +
  geom_jitter(data = ctrl.data, aes(x = Bacteria, y = rate, fill = Bacteria), 
              pch = 21, 
              size = 1.5, 
              stroke = 0.3, 
              width = 0.05) +
  ggtitle("1. MR of Control Coral Polyps exposed to E.coli (acute stress)") +
  geom_signif(comparisons = list(c("EC", "SW")), map_signif_level = TRUE) +
  #showSignificance()
  
  ylab(bquote(Oxygen~Consumption~(mu~mol ~O[2]~ min^-1~g^-1))) +
  scale_fill_manual("", values = c("grey", "white")) +
  scale_x_discrete("", limits = c("EC", "SW"), labels = c("+ EC (Acute Stress)", "- EC (Control)")) +
  #scale_y_continuous(limits = c(0, 0.1), breaks = seq(0, 0.25, by = 0.01)) +
  scale_y_continuous(limits = c(0, 0.25), breaks = seq(0, 0.25, by = 0.05)) + # for full figure incl outlier

  theme_bw()+
  theme(legend.position= "none",
        axis.ticks=element_line(size=0.1),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_rect(colour = "black", size = 0.2),
        axis.line = element_line(colour = "black", size = 0.2),
        strip.background = element_blank(),
        axis.text = element_text(size=9),
        axis.title.y = element_text(size=9)) 

ambient.control.plot.A
```

# Now let's look within our experimental treatments only (no controls)
```{r}
# Create a string of the experimental Treatment names 
Exp.Treatments <- c("PDS", "PLS", "NDS", "NLS", "PDF", "PLF", "NDF", "NLF")
```
```{r}
# Run lmer mixed effects models on experimental treatments with Polyp ID as a random effect to account for repeat measures 

for (t in 1:length(Exp.Treatments)) {
  
  tmp.data <- filter(data, Treatment == Exp.Treatments[t])
  exp.treat.lmer1 <- lmer(Lograte ~ Bacteria + (1|B.TAG), data = tmp.data) # write lmer with fixed and ID random effects
  print(paste(Exp.Treatments[t],"Q1 LMER sum:", sep = " ")) # name the summary output 
  print(summary(exp.treat.lmer1)) # print the summary output
  
#  sink(
#    paste("/Users/speroffs/Desktop/A.Poculata-Multiple-stressors-thesis-analysis-/Respiration/ModelOutputs/", # file path
#          paste(Exp.Treatments[t],"Q1 LMER sum.txt", sep = " "), # save file as with sep "" for summary
#             sep = ""))   
#  print(summary(exp.treat.lmer1)) # print summary output 
#  sink()
  
  # Posthoc ANOVA to compare model to the null
  null <- lmer(Lograte ~ 1 + (1| B.TAG), data = tmp.data) # null model without effect of bacteria
  exp.treat.lmer1.aov <- anova(null, exp.treat.lmer1) # model comparison to the null 
  print(paste(Exp.Treatments[t],"Q1 ANOVA sum:", sep = " ")) # name the summary output 
  print(exp.treat.lmer1.aov) 
  
#  sink(paste("/Users/speroffs/Desktop/A.Poculata-Multiple-stressors-thesis-analysis-/Respiration/ModelOutputs/", 
#             paste(Exp.Treatments[t],"Q1 ANOVA sum.txt", sep = " "), sep = "")) # save anova summary as txt
#  print(exp.treat.lmer1.aov)
#  sink()
 
  # Emmmeans posthoc test 
  exp.treat.lmer1.means <- emmeans(exp.treat.lmer1, list(pairwise~Bacteria)) # run emmeans on lmer object 
  print(paste(Exp.Treatments[t],"Q1 EMMEANS sum:", sep = " ")) # print emmeans summary output 
  print(summary(exp.treat.lmer1.means))
  
#  sink(paste("/Users/speroffs/Desktop/A.Poculata-Multiple-stressors-thesis-analysis-/Respiration/ModelOutputs/", 
#             paste(Exp.Treatments[t],"Q1 EMMEANS sum.txt", sep = " "), sep = "")) # save emmeans summary as txt
#  print(summary(exp.treat.lmer1.means))
#  sink()
  
}
```

```{r}
# Summarize rates by experimental reatment to plot
bac.sum <- summarySE(data, measurevar = "rate", groupvars = c("Treatment", "Bacteria"))

# Relevel 
bac.sum$Treatment <- factor(bac.sum$Treatment, 
                            levels = c("Control", "PDS", "PLS", "NDS", "NLS", "PDF", "PLF", "NDF", "NLF"))
```
```{r}
# Plot 
ggplot(data = bac.sum, 
       aes(x = Bacteria,
           y = rate,
           color = Bacteria)) +
  geom_point() +
  geom_errorbar(aes(ymin=rate-se, ymax=rate+se), width=0.1, size = 1) +
  facet_wrap(vars(Treatment)) +
  scale_color_manual(values = c("black", "royalblue3")) +
  labs(x = "Bacterial Challenge", 
       y = bquote(Metabolic~Rate~(mu~mol ~O[2]~ min^-1~g^-1))) +
  theme_classic() 
```

```{r}
# a non-faceted plot
ggplot(bac.sum, 
       aes(x= Bacteria, 
           y = rate,
           color = Treatment,
           group = Treatment)) +
  geom_point(position = position_dodge(0.2)) +
  geom_line(lty=2,position = position_dodge(0.2)) +
  geom_errorbar(aes(ymin=rate-se, ymax=rate+se), width=0.3, size = 1, position = position_dodge(0.2)) +
  scale_y_continuous(name = bquote(Metabolic~Rate~(mu~mol ~O[2]~ min^-1~g^-1))) +

  scale_color_manual(name = "", values = c("#131513", "#E02D00", "#FF7E33", 
                                                   "#D6A70A", "#ECDD09", "#075F3C", 
                                                   "#7BB12F", "#35516E", "#3F88C5")) +
  theme_classic(base_size = 15) +
  theme(legend.position = "right",
        legend.title = element_blank(),
        legend.text = element_text(size = 12),
        axis.title.x = element_text(size = 11)) 
```

###########################################################################################################################
#
#                    Question 2.  Do astrangia respond differently to e.coli over time in every treatment / 
#                        What is the effect of time on metabolic rate in each bacterial treatment?
#
###########################################################################################################################

```{r}
# Run lmer mixed effects models on experimental treatments with Polyp ID as a random effect to account for repeat measures 
# Does not include Control group - 1 time point 

for (t in 1:length(Exp.Treatments)) { # use same Exp.treatments string
  
  tmp.data <- filter(data, Treatment == Exp.Treatments[t])
  tmp.data$Day <- as.numeric(tmp.data$Day)
  exp.treat.lmer2 <- lmer(Lograte ~ Day * Bacteria + (1|B.TAG), data = tmp.data) #write lmer with fixed and ID random effects
  print(paste(Exp.Treatments[t],"Q2 LMER sum:", sep = " ")) # name the summary output 
  print(summary(exp.treat.lmer2)) # print the summary output
  
#  sink( #   paste("/Users/speroffs/Desktop/A.Poculata-Multiple-stressors-thesis-analysis-/Respiration/ModelOutputs/", # file path
#          paste(Exp.Treatments[t],"Q2 LMER sum.txt", sep = " "), # save file as with sep "" for summary
#             sep = ""))   
#  print(summary(exp.treat.lmer2)) # print summary output 
#  sink()
  
  # Posthoc ANOVA to compare model to the null
  null <- lmer(Lograte ~ 1 + (1| B.TAG), data = tmp.data) # null model without effect of bacteria
  Q1.m <- lmer(Lograte ~ Bacteria + (1| B.TAG), data = tmp.data) # q1 model 
  exp.treat.lmer2.aov <- anova(null, Q1.m, exp.treat.lmer2) # model comparison to the null and model q1
  print(paste(Exp.Treatments[t],"Q2 ANOVA sum:", sep = " ")) # name the summary output 
  print(exp.treat.lmer2.aov) 
  
#  sink(paste("/Users/speroffs/Desktop/A.Poculata-Multiple-stressors-thesis-analysis-/Respiration/ModelOutputs/", 
#             paste(Exp.Treatments[t],"Q2 ANOVA sum.txt", sep = " "), sep = "")) # save anova summary as txt
#  print(exp.treat.lmer2.aov)
#  sink()
}
```

```{r}
# look at post-hoc pairwise comparisons with day as a factor
for (t in 1:length(Exp.Treatments)) { # use same Exp.treatments string
  
  tmp.data <- filter(data, Treatment == Exp.Treatments[t])
  tmp.data$Day <- as.factor(tmp.data$Day)
  exp.treat.lmer2 <- lmer(Lograte ~ Day * Bacteria + (1|B.TAG), data = tmp.data) #write lmer with fixed and ID random effects
  
  # Emmmeans posthoc test 
  exp.treat.lmer2.means <- emmeans(exp.treat.lmer2, list(pairwise~Day:Bacteria)) # run emmeans on lmer object 
  print(paste(Exp.Treatments[t],"Q2 EMMEANS sum:", sep = " ")) # print emmeans summary output 
  print(summary(exp.treat.lmer2.means))
  
#  sink(paste("/Users/speroffs/Desktop/A.Poculata-Multiple-stressors-thesis-analysis-/Respiration/ModelOutputs/", 
#             paste(Exp.Treatments[t],"Q2 EMMEANS sum.txt", sep = " "), sep = "")) # save emmeans summary as txt
#  print(summary(exp.treat.lmer2.means))
#  sink()
}
```

```{r}
# Filter out experimental treatments
exp.data <- filter(data, Treatment != "Control")  

# Summarize means and sem to plot using the expt.data frame
bac.day.sum <- summarySE(exp.data, measurevar = "rate", groupvars = c("Treatment", "Day", "Bacteria"))
```
```{r}
# Plot
resp.treat.time.plot <-
ggplot(data = bac.day.sum, 
       aes(x = Day, 
           y = rate, 
           group = Bacteria,
           col = Bacteria,
           linetype= Bacteria)) +
  
  geom_point(size = 1.5) +
  geom_line(size = 1.2) +
  geom_errorbar(aes(ymin=rate-se, ymax=rate+se),width=0.1, size = 1, lty=1) +
  
  scale_linetype_manual(labels = c("Acute Challenge (EC)", "Basal (SW)"),values = c(1, 1)) +
  scale_color_manual(labels = c("Acute Challenge (EC)", "Basal (SW)"), values=c("black","gray47")) +
  facet_wrap(vars(Treatment)) +

  labs(x = "\nDay") +
  scale_y_continuous(limits = c(0, 0.075), breaks = seq(0, 0.075, by = 0.025)) +
  ylab(bquote(Metabolic~Rate~(mu~mol ~O[2]~ min^-1~g^-1))) +

  theme_classic(base_size = 13) +
   theme(legend.position = c(0.83,0.15),
        legend.title = element_blank(),
        legend.text = element_text(size = 12),
        axis.text.y = element_text(size = 12),
        axis.text.x = element_text(size = 14)) 

resp.treat.time.plot
```
```{r}
# save plot
ggsave(plot = resp.treat.time.plot,
       filename = "/Users/speroffs/Desktop/A.Poculata-Multiple-stressors-thesis-analysis-/Respiration/Figures/treat.over.tine.EC.SW.jpg", width = 8, height = 6, units = "in", dpi = 300)
```

###########################################################################################################################
#
#                 Question 3. Do astrangia phenotypes respond differently to e.coli in every treatment / 
#                                 What is the effect of phenotype on metabolic rate?
#
###########################################################################################################################

```{r}
# Start with Control data (lm for non repeat obs)
ctrl.lm3 <- lm(Lograte~Sym.state*Bacteria, data=ctrl.data)
summary(ctrl.lm3) # view summary
anova(ctrl.lm3)

# Tukey post hoc 
ctrl.aov3 <- aov(Lograte~Sym.state*Bacteria, data=ctrl.data) # for tukey test
ctrl.tukey3 <- TukeyHSD(ctrl.aov3, which = 'Sym.state:Bacteria')
ctrl.tukey3 # view tukey output
```

## Plot the ambient controls
```{r}
# Summarize
ctrl.phen.means <-summarySE(ctrl.data, measurevar = "rate", groupvars = c("Bacteria", "Sym.state"))

# plot
ctrl.resp.B <-
  ggplot(ctrl.phen.means, aes(x = Bacteria, 
                         y = rate, 
                         col = Sym.state, 
                         group = Sym.state)) +
  geom_point(size = 2) +
  #geom_line() +
  geom_errorbar(aes(ymin=rate-se, ymax=rate+se), width=0.1, size = 1.2) +
  scale_color_manual(labels = c("Apo", "Sym"), values = c("tan", "coral4")) +
  scale_x_discrete(name = "", limits = c("EC", "SW"), labels = c("Acute", "Basal")) +
  scale_y_continuous(name = "", limits = c(0.01, 0.074), breaks = seq(0.01, 0.075, by = 0.015)) +
  ggtitle("B") +

  theme_classic(base_size = 12) +
  theme(
    #panel.border = element_rect(fill=NA),
    legend.position = c(0.75,0.9),
    legend.title = element_blank(),
    legend.text = element_text(size = 10),
   # legend.box.background = element_rect(color="black", size=0.5),
    plot.title = element_text(vjust = 1.1, size = 18, face="bold"),
        )
ctrl.resp.B
```

```{r}
## REFORMAT ABOVE FIGURE FOR PUBLICATION

ambient.control.plot.B<-
  ggplot(ctrl.data, aes(x = Bacteria, 
                         y = rate, 
                         color = Sym.state,
                         fill = Sym.state)) +
  geom_boxplot(width =0.8,
               outlier.shape = NA,
               lwd = 0.5,
               color = "black") +
  geom_point(pch = 21, 
             size = 1.2, 
             stroke = 0.3, 
             width = 0.05,
             color = "black",
             position=position_jitterdodge()) +

  ylab(bquote(Metabolic~Rate~(mu~mol ~O[2]~ min^-1~g^-1))) +
  
  scale_color_manual(labels = c("Apo", "Sym"), values = c("tan", "coral4")) +
  scale_fill_manual(values=c("tan","coral4")) +
  scale_x_discrete(name = "", limits = c("EC", "SW"), labels = c("+ EC (Acute Stress)", "- EC (Control)")) +
#  scale_y_continuous(limits = c(0., 0.3), breaks = seq(0, 0.3, by = 0.1)) + #full scale with outliers
  scale_y_continuous(limits = c(0.0, 0.1), breaks = seq(0, 0.1, by = 0.01)) + #cropped without outliers
    
  ggtitle("2. Influence of Phenotype on Acute Stress Response (Ambient Temp)") +

  theme_bw()+
  theme(legend.position= "none",
        axis.ticks=element_line(size=0.1),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_rect(colour = "black", size = 0.2),
        axis.line = element_line(colour = "black", size = 0.2),
        strip.background = element_blank(),
        axis.text = element_text(size=9),
        axis.title.y = element_text(size=9)) 

ambient.control.plot.B
```

# Arrange ambient-control figures A and B
```{r}
amb.ctrl.resp <- ggarrange(ctrl.resp.A, ctrl.resp.B, 
                           nrow = 1, labels = NA, widths = c(2, 2.2), align = "v") 
                #theme(plot.margin = margin(10, 10, 10, 15))

amb.ctrl.resp <- annotate_figure(amb.ctrl.resp, 
                              bottom = text_grob("Acute Stress Challenge", 
                              hjust = 0.4, vjust = -1.5, size = 12, face = "bold"))
amb.ctrl.resp
```
```{r}
# save plot
ggsave(plot = amb.ctrl.resp,
       filename = "/Users/speroffs/Desktop/A.Poculata-Multiple-stressors-thesis-analysis-/Respiration/Figures/amb.ctrl.panel.jpg", width = 6, height = 4, units = "in", dpi=300)
```

# Now run the analysis with our experimental treatments 
```{r}
# Run lmer mixed effects models on experimental treatments with Polyp ID as a random effect to account for repeat measures 

for (t in 1:length(Exp.Treatments)) { # use same Exp.treatments string
  
  tmp.data <- filter(data, Treatment == Exp.Treatments[t])
  exp.treat.lmer3 <- lmer(Lograte ~ Sym.state * Bacteria + (1|B.TAG), data = tmp.data)
  print(paste(Exp.Treatments[t],"Q3 LMER sum:", sep = " ")) # name the summary output 
  print(summary(exp.treat.lmer3)) # print the summary output
  
#  sink(
#    paste("/Users/speroffs/Desktop/A.Poculata-Multiple-stressors-thesis-analysis-/Respiration/ModelOutputs/", # file path
#          paste(Exp.Treatments[t],"Q3 LMER sum.txt", sep = " "), # save file as with sep "" for summary
#             sep = ""))   
#  print(summary(exp.treat.lmer3)) # print summary output 
#  sink()
  
  # Posthoc ANOVA to compare model to the null
  null <- lmer(Lograte ~ 1 + (1| B.TAG), data = tmp.data) # null model without effects
  Q1.m <- lmer(Lograte ~ Bacteria + (1| B.TAG), data = tmp.data) # q1 model with bacteria
  
  exp.treat.lmer3.aov <- anova(null, Q1.m, exp.treat.lmer3) # model comparison to the null 
  print(paste(Exp.Treatments[t],"Q3 ANOVA sum:", sep = " ")) # name the summary output 
  print(exp.treat.lmer3.aov) 
  
#  sink(paste("/Users/speroffs/Desktop/A.Poculata-Multiple-stressors-thesis-analysis-/Respiration/ModelOutputs/", 
#             paste(Exp.Treatments[t],"Q3 ANOVA sum.txt", sep = " "), sep = "")) # save anova summary as txt
#  print(exp.treat.lmer3.aov)
#  sink()
 
  # Emmmeans posthoc test 
  exp.treat.lmer3.means <- emmeans(exp.treat.lmer3, list(pairwise~Sym.state:Bacteria)) # run emmeans on lmer object 
  print(paste(Exp.Treatments[t],"Q3 EMMEANS sum:", sep = " ")) # print emmeans summary output 
  print(summary(exp.treat.lmer3.means))
  
#  sink(paste("/Users/speroffs/Desktop/A.Poculata-Multiple-stressors-thesis-analysis-/Respiration/ModelOutputs/", 
#             paste(Exp.Treatments[t],"Q3 EMMEANS sum.txt", sep = " "), sep = "")) # save emmeans summary as txt
#  print(summary(exp.treat.lmer3.means))
#  sink()
}
```

```{r}
# Summarize tmeans within experimental treatments
phen.means <- summarySE(exp.data, measurevar = "rate", groupvars = c("Treatment", "Bacteria", "Sym.state"))
```
```{r}
# Plot
resp.phen.plot <-
ggplot(data = phen.means, 
                     aes(x = Bacteria, 
                         y = rate, 
                         col = Sym.state, 
                         group = Sym.state)) +
  geom_point(size = 1.5) +
  geom_errorbar(aes(ymin=rate-se, ymax=rate+se), width=0.1, size = 1.2) +
  geom_line()+
  
  facet_wrap(vars(Treatment)) +
  scale_color_manual(labels = c("Aposymbiotic", "Symbiotic"), values = c("tan", "coral4")) +
  scale_x_discrete(name = "Acute Challenge",
                   limits = c("EC", "SW"),
                   labels = c("Acute", "Basal")) +
  
    ylab(bquote(Metabolic~Rate~(mu~mol ~O[2]~ min^-1~g^-1))) +

  theme_classic(base_size = 13) +
   theme(legend.position = c(0.83,0.15),
        legend.title = element_blank(),
        legend.text = element_text(size = 13),
        axis.text.y = element_text(size = 13))
resp.phen.plot
```
```{r}
# save plot
ggsave(plot = resp.phen.plot,
       filename = "/Users/speroffs/Desktop/A.Poculata-Multiple-stressors-thesis-analysis-/Respiration/Figures/exp.phenotype.jpg", width = 8, height = 6, units = "in", dpi = 300)
```

###########################################################################################################################
#
#             Question 4. Do astrangia phenotypes respond differently to e.coli over time in every treatment / 
#                                What is the effect of phenotype over time on metabolic rate?
#
###########################################################################################################################

```{r}
# Run lmer mixed effects models on experimental treatments with Polyp ID as a random effect to account for repeat measures 
# Does not include Control group - 1 time point 

for (t in 1:length(Exp.Treatments)) { # use same Exp.treatments string
  
  tmp.data <- filter(data, Treatment == Exp.Treatments[t])
  tmp.data$Day <- as.numeric(tmp.data$Day)
  
  exp.treat.lmer4 <- lmer(Lograte ~ Sym.state * Day * Bacteria + (1|B.TAG), data = tmp.data) 
  print(paste(Exp.Treatments[t],"Q4 LMER sum:", sep = " ")) # name the summary output 
  print(summary(exp.treat.lmer4)) # print the summary output
  
#  sink(
#    paste("/Users/speroffs/Desktop/A.Poculata-Multiple-stressors-thesis-analysis-/Respiration/ModelOutputs/", # file path
#          paste(Exp.Treatments[t],"Q4 LMER sum.txt", sep = " "), # save file as with sep "" for summary
#             sep = ""))   
#  print(summary(exp.treat.lmer4)) # print summary output 
#  sink()
  
  # Posthoc ANOVA to compare model to the null and previous 
  null <- lmer(Lograte ~ 1 + (1| B.TAG), data = tmp.data) # null model without effects
  Q1.m <- lmer(Lograte ~ Bacteria + (1| B.TAG), data = tmp.data) # q1 model with bacteria
  Q2.m <- lmer(Lograte ~ Day * Bacteria + (1|B.TAG), data = tmp.data) # q2 model
  Q3.m <- lmer(Lograte ~ Sym.state * Bacteria + (1|B.TAG), data = tmp.data) # q3 model with phenotype, bacteria, and day
  
  exp.treat.lmer4.aov <- anova(null, Q1.m, Q2.m, Q3.m, exp.treat.lmer4) # model comparison 
  print(paste(Exp.Treatments[t],"Q4 ANOVA sum:", sep = " ")) # name the summary output 
  print(exp.treat.lmer4.aov) 
  
#  sink(paste("/Users/speroffs/Desktop/A.Poculata-Multiple-stressors-thesis-analysis-/Respiration/ModelOutputs/", 
#             paste(Exp.Treatments[t],"Q4 ANOVA sum.txt", sep = " "), sep = "")) # save anova summary as txt
#  print(exp.treat.lmer4.aov)
#  sink()
}
```

```{r}
# Pairwise means with day as factor 
for (t in 1:length(Exp.Treatments)) { # use same Exp.treatments string
  
  tmp.data <- filter(data, Treatment == Exp.Treatments[t])
  tmp.data$Day <- as.factor(tmp.data$Day)
  exp.treat.lmer4 <- lmer(rate ~ Sym.state * Day * Bacteria + (1|B.TAG), data = tmp.data)
  
 # Emmmeans posthoc test 
  exp.treat.lmer4.means <- emmeans(exp.treat.lmer4, list(pairwise~Sym.state:Day:Bacteria)) # run emmeans on lmer object 
  print(paste(Exp.Treatments[t],"Q4 EMMEANS sum:", sep = " ")) # print emmeans summary output 
  print(summary(exp.treat.lmer4.means))
  
#  sink(paste("/Users/speroffs/Desktop/A.Poculata-Multiple-stressors-thesis-analysis-/Respiration/ModelOutputs/", 
#             paste(Exp.Treatments[t],"Q4 EMMEANS sum.txt", sep = " "), sep = "")) # save emmeans summary as txt
#  print(summary(exp.treat.lmer4.means))
#  sink() 
}
```

```{r}
# Summarize means within experimental controls
time.phen.means <- summarySE(exp.data, measurevar = "rate", groupvars = c("Treatment", "Day", "Bacteria", "Sym.state"))
```
```{r}
# Plot 
ggplot(data = time.phen.means, 
                     aes(x = Day, 
                         y = rate, 
                         col = Sym.state, 
                         group = interaction(Bacteria, Sym.state))) +
  geom_line(aes(color = Sym.state, linetype = Bacteria)) +
  geom_point() +
  facet_wrap(vars(Treatment)) +
  geom_errorbar(aes(ymin=rate-se, ymax=rate+se), width=0.2, size = 1) +
  labs(x = "\nDay", 
       y = bquote(Metabolic~Rate~(mu~mol ~O[2]~ min^-1~g^-1)))+
  theme_classic() +
  scale_color_manual(values = c("tan", "coral4")) 

# Future troubleshoot: how to combine the legend for an interaction plot
```

#########################################################################################################################
#
#                 Question 1. Does plastic/food/light/temperature/Phenotype affect metabolic rate /
#                            What is the effect of the stressor on metabolic rate?
#
#########################################################################################################################

# For all Thermal stress comparisons, perform LM at day 22 for accurate analysis 
```{r}
# Isolate day 22 for thermal stress to run simple lm (ambient temp only 1 obs/ID)
temp22.data <- filter(data, Day == "22")

# Run lm 
temp.lm1 <- lm(rate ~ Temperature, data = temp22.data)
summary(temp.lm1)

# tukey post-hoc
temp.aov1 <- aov(rate ~ Temperature, data = temp22.data)
temp.tukey1 <- TukeyHSD(temp.aov1)
temp.tukey1
```

# Plot by temperature
```{r}
# Summarize means within temperature treatments 
temperature.sum1 <- summarySE(temp22.data, measurevar = "rate", groupvars = "Temperature")

# Plot
ggplot(data = temperature.sum1,
       aes(x = Temperature,
           y = rate,
           color = Temperature)) +
  
    geom_point(size = 2) +
    geom_errorbar(aes(ymin=rate-se, ymax=rate+se), width=0.1, size = 1.5) +
    labs(x = "\n", 
         y = bquote(Metabolic~Rate~(mu~mol ~O[2]~ min^-1~g^-1))) +
    ggtitle ("Temperature at Day 22") +
    scale_color_manual(values = c("royalblue4","firebrick2")) +

  
   theme_classic(base_size=14) +
   theme(legend.position = "none",
        legend.title = element_blank(),
        legend.text = element_text(size = 16))
```

# Now let's look at our stressors (and phenotype) within our elevated experimental treatments
```{r}
# Create string of stressors 
stressors <- c("Plastic", "Food", "Light", "Sym.state")
```
```{r}
# Run lmer mixed effects models on experimental stressors with Polyp ID as a random effect to account for repeat measures 
for (s in 1:length(stressors)) {

  s.lmer1 <- lmer(as.formula(paste("Lograte~",paste(stressors[s]), "+ (1|B.TAG)")), data = exp.data) # experimental data
  print(paste(stressors[s],"Q1 LMER sum:", sep = " "))
  print(summary(s.lmer1)) 
  
#  sink(paste("/Users/speroffs/Desktop/A.Poculata-Multiple-stressors-thesis-analysis-/Respiration/ModelOutputs/", 
#             paste(stressors[s],"Q1 LMER sum.txt", sep = " "), sep = ""))
#  print(summary(s.lmer1))
#  sink()
  
  # Posthoc ANOVA to compare model to the null
  null <- lmer(Lograte ~ 1 + (1| B.TAG), data = exp.data) # null model without effects using experimental treatments only
  s.lmer1.aov <- anova(null, s.lmer1) # model comparison 
  print(paste(stressors[s],"Q1 ANOVA sum:", sep = " ")) # name the summary output 
  print(s.lmer1.aov) 
  
#  sink(paste("/Users/speroffs/Desktop/A.Poculata-Multiple-stressors-thesis-analysis-/Respiration/ModelOutputs/", 
#             paste(stressors[s],"Q1 ANOVA sum.txt", sep = " "), sep = "")) # save anova summary as txt
#  print(s.lmer1.aov)
#  sink()
  
  # Emmmeans posthoc test 
  s.lmer1.means <- emmeans(s.lmer1, as.formula(paste("list(pairwise)~",stressors[s])))
  print(paste(stressors[s],"Q1 EMMEANS sum:", sep = " "))
  print(summary(s.lmer1.means))
  
#  sink(paste("/Users/speroffs/Desktop/A.Poculata-Multiple-stressors-thesis-analysis-/Respiration/ModelOutputs/", 
#             paste(stressors[s],"Q1 EMMEANS sum.txt", sep = " "), sep = ""))
#  print(summary(s.lmer1.means))
#  sink()
}
```

```{r}
# Summarize by plastic
plastic.sum1 <- summarySE(exp.data, measurevar = "rate", groupvars = "Plastic")

# Visualize
ggplot(data = plastic.sum1,
       aes(x = Plastic,
           y = rate,
           color = Plastic)) +
  
    geom_point(size = 2) +
    geom_errorbar(aes(ymin=rate-se, ymax=rate+se), width=0.1, size = 1.5) +
  
    labs(x = "\n", 
         y = bquote(Metabolic~Rate~(mu~mol ~O[2]~ min^-1~g^-1))) +
    scale_x_discrete(name = "", # remove labels for paneling 
                   limits = c("NoPlastic", "Plastic"),
                   labels = c("No Plastic", "Plastic")) +
    scale_color_manual(labels = c("No plastic", "Plastic"), 
                     values = c("black","forestgreen")) +
    ggtitle ("Plastic") +

  
   theme_classic(base_size=14) +
   theme(legend.position = "none",
        legend.title = element_blank(),
        legend.text = element_text(size = 16))
```

```{r}
# Summarize by food
food.sum1 <- summarySE(exp.data, measurevar = "rate", groupvars = "Food")

# Visualize
ggplot(data = food.sum1,
       aes(x = Food,
           y = rate,
           color = Food)) +
  
    geom_point(size = 2) +
    geom_errorbar(aes(ymin=rate-se, ymax=rate+se), width=0.1, size = 1.5) +
    labs(x = "\n", 
         y = bquote(Metabolic~Rate~(mu~mol ~O[2]~ min^-1~g^-1))) +
    ggtitle ("Food") +
    scale_color_manual(values = c("orangered4","black")) +
  
   theme_classic(base_size=14) +
   theme(legend.position = "none",
        legend.title = element_blank(),
        legend.text = element_text(size = 16))
```

```{r}
# Summarize by light
light.sum1 <- summarySE(exp.data, measurevar = "rate", groupvars = "Light")

# Visualize
ggplot(data = light.sum1,
       aes(x = Light,
           y = rate,
           color = Light)) +
  
    geom_point(size = 2) +
    geom_errorbar(aes(ymin=rate-se, ymax=rate+se), width=0.1, size = 1.5) +
    labs(x = "\n", 
         y = bquote(Metabolic~Rate~(mu~mol ~O[2]~ min^-1~g^-1))) +
    ggtitle ("Light") +
    scale_color_manual(values = c("black","darkgoldenrod1")) +
  
   theme_classic(base_size=14) +
   theme(legend.position = "none",
        legend.title = element_blank(),
        legend.text = element_text(size = 16))
```

```{r}
# Summarize by phenotype
phenotype.sum1 <- summarySE(exp.data, measurevar = "rate", groupvars = "Sym.state")

# Visualize
ggplot(data = phenotype.sum1,
       aes(x = Sym.state,
           y = rate,
           color = Sym.state)) +
  
    geom_point(size = 2) +
    geom_errorbar(aes(ymin=rate-se, ymax=rate+se), width=0.1, size = 1.5) +
    labs(x = "\n", 
         y = bquote(Metabolic~Rate~(mu~mol ~O[2]~ min^-1~g^-1))) +
    scale_x_discrete(name = "", # remove labels for paneling 
                   limits = c("apo", "sym"),
                   labels = c("Aposymbiotic", "Symbiotic")) +
    scale_color_manual(values = c("tan","coral4")) +
    ggtitle ("Phenotype") +
  
   theme_classic(base_size=14) +
   theme(legend.position = "none",
        legend.title = element_blank(),
        legend.text = element_text(size = 16))
```

#########################################################################################################################
#
#                           Question 2. Does stressor impact the response to e.coli / 
#                  What is the effect of the stressor in each bacterial treatment on metabolic rate?
#
#########################################################################################################################

# Isolate the temperature analysis to day 22
```{r}
# Linear model
temp.lm2 <- lm(Lograte ~ Temperature * Bacteria, data = temp22.data)
summary(temp.lm2)

# Tukey post hoc 
temp.aov2 <- aov(Lograte ~ Temperature * Bacteria, data = temp22.data) # for tukey test
temp.tukey2 <- TukeyHSD(temp.aov2, which = 'Temperature:Bacteria')
temp.tukey2 # view tukey output
```

# Plot temperature
```{r}
# Summarize by Temperature and bacteria 
temperature.sum2 <- summarySE(temp22.data, measurevar = "rate", groupvars = c("Temperature","Bacteria"))

# Plot
temp.plot.A <- 
ggplot(data = temperature.sum2,
       aes(x = Bacteria,
           y = rate, 
           col = Temperature, 
           group = Temperature)) +
    geom_point(size = 2) +
   # geom_line() +
    geom_errorbar(aes(ymin=rate-se, ymax=rate+se), width=0.1, size = 1) +
  
    scale_x_discrete(
     # name = "Acute stress challenge", 
      limits = c("EC", "SW"), labels = c("Acute", "Basal")) +
    scale_color_manual(labels = c("Ambient", "Elevated"), values = c("royalblue4","firebrick2")) +
   # scale_y_continuous(limits = c(0, 0.041)) +

  ggtitle ("A") +
    
  ylab(bquote(Metabolic~Rate~(mu~mol ~O[2]~ min^-1~g^-1))) +
  xlab("")+

  theme_classic() +
  theme_classic(base_size=16) +
  theme(legend.position = c(0.75, 0.9),
        legend.title = element_blank(),
        legend.text = element_text(size = 12),
        plot.title = element_text(vjust = 1.1, size = 18, face="bold"),
        plot.margin = margin(1, 0, 1, 1)
)
temp.plot.A
```
```{r}
# save
#ggsave(plot = resp.temp.plot,
#       filename = "/Users/speroffs/Desktop/A.Poculata-Multiple-stressors-thesis-analysis-/Respiration/Figures/temp.plot.A.jpg", width = 5, height = 6, units = "in")
```

```{r}
## REFORMAT ABOVE FIGURE FOR PUBLICATION

temp.day.22.plot.A<-
  ggplot(temp22.data, aes(x = Bacteria, 
                         y = rate, 
                         color = Temperature,
                         fill = Temperature)) +
  geom_boxplot(width =0.8,
               outlier.shape = NA,
               lwd = 0.5,
               color = "black") +
  geom_point(pch = 21, 
             size = 1.2, 
             stroke = 0.3, 
             width = 0.05,
             color = "black",
             position=position_jitterdodge()) +

  ylab(bquote(Metabolic~Rate~(mu~mol ~O[2]~ min^-1~g^-1))) +
  
  scale_color_manual(labels = c("Ambient", "Elevated"), values = c("royalblue4","firebrick2")) +
  scale_fill_manual(values=c("royalblue4","firebrick2")) +
  scale_x_discrete(name = "", limits = c("EC", "SW"), labels = c("+ EC (Acute Stress)", "- EC (Control)")) +
#  scale_y_continuous(limits = c(0., 0.28), breaks = seq(0, 0.25, by = 0.05)) + #full scale with outliers
  scale_y_continuous(limits = c(0, 0.1), breaks = seq(0, 0.1, by = 0.02)) + #cropped without outliers
    
  ggtitle("3. Chronic Thermal Stress Reduces Metabolic Response to Acute Stress") +

  theme_bw()+
  theme(legend.position= "right",
        axis.ticks=element_line(size=0.1),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_rect(colour = "black", size = 0.2),
        axis.line = element_line(colour = "black", size = 0.2),
        strip.background = element_blank(),
        axis.text = element_text(size=9),
        axis.title.y = element_text(size=9)) 

temp.day.22.plot.A
```

```{r}
# Run lmer mixed effects models on experimental stressors with Polyp ID as a random effect to account for repeat measures
for (s in 1:length(stressors)) {

  s.lmer2 <- lmer(as.formula(paste("Lograte ~", paste(stressors[s]), "* Bacteria + (1|B.TAG)")), data = exp.data) 
  print(paste(stressors[s],"Q2 LMER sum:", sep = " "))
  print(summary(s.lmer2)) 
  
#  sink(paste("/Users/speroffs/Desktop/A.Poculata-Multiple-stressors-thesis-analysis-/Respiration/ModelOutputs/", 
#             paste(stressors[s],"Q2 LMER sum.txt", sep = " "), sep = ""))
#  print(summary(s.lmer2))
#  sink()
  
  # Posthoc ANOVA to compare model to the null
  null <- lmer(rate ~ 1 + (1| B.TAG), data = exp.data) # null model without effects using experimental treatments only 
  Q1 <- lmer(as.formula(paste("Lograte~",paste(stressors[s]), "+ (1|B.TAG)")), data = exp.data)
  
  s.lmer2.aov <- anova(null, Q1, s.lmer2) # model comparison 
  print(paste(stressors[s],"Q2 ANOVA sum:", sep = " ")) # name the summary output 
  print(s.lmer2.aov) 
  
#  sink(paste("/Users/speroffs/Desktop/A.Poculata-Multiple-stressors-thesis-analysis-/Respiration/ModelOutputs/", 
#             paste(stressors[s],"Q2 ANOVA sum.txt", sep = " "), sep = "")) # save anova summary as txt
# print(s.lmer2.aov)
# sink()
  
  # Emmmeans posthoc test 
  s.lmer2.means <- emmeans(s.lmer2, as.formula(paste("list(pairwise)~",stressors[s],":Bacteria")))
  print(paste(stressors[s],"Q2 EMMEANS sum:", sep = " "))
  print(summary(s.lmer2.means))
  
#  sink(paste("/Users/speroffs/Desktop/A.Poculata-Multiple-stressors-thesis-analysis-/Respiration/ModelOutputs/", 
#             paste(stressors[s],"Q2 EMMEANS sum.txt", sep = " "), sep = ""))
#  print(summary(s.lmer2.means))
#  sink()
}
```

```{r}
# Summarize by plastic and bacteria 
plastic.sum2 <- summarySE(data, measurevar = "rate", groupvars = c("Plastic","Bacteria"))

# Plot
plastic.plot.A <- 
ggplot(data = plastic.sum2,
       aes(x = Bacteria,
           y = rate, 
           color = Plastic)) +
  
    geom_point(size = 2) +
    geom_errorbar(aes(ymin=rate-se, ymax=rate+se), width=0.1, size = 1) +
  
    scale_x_discrete(
      #name = "Acute stress challenge", 
      limits = c("EC", "SW"), labels = c("Acute", "Basal")) +
    scale_color_manual(labels = c("No Plastic", "Plastic"), values = c("black", "forestgreen")) +
    scale_y_continuous(limits = c(0, 0.041)) +

  ggtitle ("A. Plastic") +
    
  ylab(bquote(Metabolic~Rate~(mu~mol ~O[2]~ min^-1~g^-1))) +
  ylab("")+
  xlab("")+

  theme_classic() +
  theme_classic(base_size=16) +
  theme(legend.position = c(0.75, 0.9),
        legend.title = element_blank(),
        legend.text = element_text(size = 12),
        plot.title = element_text(vjust = 1.1, size = 18, face="bold"))
plastic.plot.A
```

```{r}
# Summarize by Light and bacteria 
light.sum2 <- summarySE(data, measurevar = "rate", groupvars = c("Light","Bacteria"))

# Plot
light.plot.A <-
ggplot(data = light.sum2,
       aes(x = Bacteria,
           y = rate, 
           color = Light)) +
    geom_point(size = 2) +
    geom_errorbar(aes(ymin=rate-se, ymax=rate+se), width=0.1, size = 1) +
  
    scale_x_discrete(
      #name = "Acute stress challenge", 
      limits = c("EC", "SW"), labels = c("Acute", "Basal")) +
    scale_color_manual(labels = c("Dark", "Light"), values = c("black", "goldenrod1")) +
    scale_y_continuous(limits = c(0, 0.041)) +

  ggtitle ("B. Light") +
    
 # ylab(bquote(Metabolic~Rate~(mu~mol ~O[2]~ min^-1~g^-1))) +
  ylab("")+
  xlab("")+

  theme_classic() +
  theme_classic(base_size=16) +
  theme(legend.position = c(0.75, 0.9),
        legend.title = element_blank(),
        legend.text = element_text(size = 12),
        plot.title = element_text(vjust = 1.1, size = 18, face="bold"))
light.plot.A
```
```{r}
# ADDED Feb 8, 2025

# Subset the above figure by sym state - 

#create subset of our variables 
light.sum3 <- summarySE(data, measurevar = "rate", groupvars = c("Light","Bacteria", "Sym.state"))

# Plot
light.plot.B <-
ggplot(data = light.sum3,
       aes(x = Bacteria,
           y = rate, 
           color = Sym.state)) +
    geom_point(size = 2) +
    geom_errorbar(aes(ymin=rate-se, ymax=rate+se), width=0.1, size = 1) +
    facet_wrap(vars(Light)) +
    scale_x_discrete(
      #name = "Acute stress challenge", 
      limits = c("EC", "SW"), labels = c("Acute", "Basal")) +
    scale_color_manual(labels = c("Apo", "Sym"), values = c("tan","coral4")) +
    scale_y_continuous(limits = c(0, 0.041)) +

  #ggtitle ("B. Light") +
    
  ylab(bquote(Metabolic~Rate~(mu~mol ~O[2]~ min^-1~g^-1))) +
 # ylab("")+
  xlab("")+

  theme_classic() +
  theme_classic(base_size=16) +
  theme(#legend.position = c(0.75, 0.9),
        legend.title = element_blank(),
        legend.text = element_text(size = 12),
        plot.title = element_text(vjust = 1.1, size = 18, face="bold"))
light.plot.B
```

```{r}
# Summarize by Food and bacteria 
food.sum2 <- summarySE(data, measurevar = "rate", groupvars = c("Food","Bacteria"))

# Plot
food.plot.A <-
ggplot(data = food.sum2,
       aes(x = Bacteria,
           y = rate, 
           color = Food)) +
    geom_point(size = 2) +
    geom_errorbar(aes(ymin=rate-se, ymax=rate+se), width=0.1, size = 1) +
  
    scale_x_discrete(
      #name = "Acute stress challenge", 
      limits = c("EC", "SW"), labels = c("Acute", "Basal")) +
    scale_color_manual(labels = c("Fed", "Starved"), values = c("orangered4", "black")) +
    scale_y_continuous(limits = c(0, 0.041)) +

  ggtitle ("C. Food") +
    
 # ylab(bquote(Metabolic~Rate~(mu~mol ~O[2]~ min^-1~g^-1))) +
  ylab("") +
  xlab("")+

  theme_classic() +
  theme_classic(base_size=16) +
  theme(legend.position = c(0.75, 0.9),
        legend.title = element_blank(),
        legend.text = element_text(size = 12),
        plot.title = element_text(vjust = 1.1, size = 18, face="bold"))
food.plot.A
```
```{r}
# Arrange plastic, light, and food

local.panel1 <- ggarrange(plastic.plot.A, ggplot()+theme_void(), 
                        widths = c(1, 1), common.legend = FALSE)

local.panel2 <- ggarrange(light.plot.A, food.plot.A,
                        common.legend = FALSE, 
                        labels = NA, 
                        widths=c(1,1))

local.panel <- ggarrange(local.panel1, local.panel2,
                   common.legend = FALSE,
                   labels = NA,
                   ncol=1)

local.panel <-annotate_figure(local.panel, 
                        bottom = text_grob("Acute Challenge",hjust = 0.4, vjust = -0.5, size = 18), 
                        left = text_grob(bquote(Metabolic~Rate~(mu~mol ~O[2]~ min^-1~g^-1)), rot = 90, 
                                         vjust = 1, hjust = 0.5, size = 18))
local.panel
```
```{r}
# Save plot
ggsave(plot = local.panel,
       filename = "/Users/speroffs/Desktop/A.Poculata-Multiple-stressors-thesis-analysis-/Respiration/Figures/local.panel.jpg", width = 8, height = 6, units = "in", dpi = 300)
```


```{r}
# Summarize by Phenotype and bacteria 
phenotype.sum2 <- summarySE(data, measurevar = "rate", groupvars = c("Sym.state","Bacteria"))

# Plot
ggplot(data = phenotype.sum2,
       aes(x = Bacteria,
           y = rate, 
           color = Sym.state)) +
    geom_point(size = 2) +
    geom_errorbar(aes(ymin=rate-se, ymax=rate+se), width=0.1, size = 1) +
  
    scale_x_discrete(
      #name = "Acute stress challenge", 
      limits = c("EC", "SW"), labels = c("Acute", "Basal")) +
    scale_color_manual(labels = c("Aposymbiotic", "Symbiotic"), values = c("tan", "coral4")) +
    scale_y_continuous(limits = c(0, 0.041)) +

  ggtitle ("Phenotype") +
    
 # ylab(bquote(Metabolic~Rate~(mu~mol ~O[2]~ min^-1~g^-1))) +
  ylab("") +
  xlab("")+

  theme_classic() +
  theme_classic(base_size=16) +
  theme(legend.position = c(0.75, 0.9),
        legend.title = element_blank(),
        legend.text = element_text(size = 12),
        plot.title = element_text(vjust = 1.1, size = 18, face="bold"))
```

# Arrange temp, plastic, food, and light plots
```{r}
stressor.panel1 <- ggarrange(temp.plot.A, plastic.plot.A, light.plot.A, food.plot.A, 
          ncol = 1, common.legend = FALSE, heights = c(5,5,5,5)) 

stressor.panel1
```


#########################################################################################################################
#
#                           Question 3. Does the stressor impact the response to e.coli over time / 
#                    What is the effect of the stressor in each bacterial treatment on metabolic rate over time?
#
#########################################################################################################################

# Is there an affect of just elevated temperature over time? (does not include ambient)
```{r}
# Use experimental data set

# Run lm for bacteria over time at thermal stress
temp.lmer3 <- lmer(rate ~ Bacteria * Day + (1|B.TAG), data = exp.data)
summary(temp.lmer3)

# ANOVA model comparison
null <- lmer(rate ~ 1 + (1| B.TAG), data = exp.data) # null for this data set
Q2 <- lmer(rate ~ Bacteria + (1|B.TAG), data = exp.data) # model without day for this data set
temp.lmer3.aov <- anova(null, Q2, temp.lmer3) #model comparison 
  
# Emmeans posthoc
temp.lmer3.3 <- lmer(rate ~ Bacteria * as.factor(Day) + (1|B.TAG), data = exp.data)
temp.means3 <- emmeans(temp.lmer3.3, list(pairwise~"Bacteria:Day"))
temp.means3 # view tukey output
```

# Visualize elev temp over time
```{r}
# Summarize by bacteria over time at elevated temperature 
temp.sum3 <- summarySE(exp.data, measurevar = "rate", groupvars = c("Day", "Bacteria"))

# Plot 
ggplot(temp.sum3, 
       aes(x = Day, 
           y = rate, 
           col = Bacteria,
           group = Bacteria)) +
  geom_line() +
  geom_point() +
  ggtitle("Elevated Temperature") +
  geom_errorbar(aes(ymin=rate-se, ymax=rate+se), width=0.2, size = 1) +
  labs(x = "\nDay", 
       y = bquote(Metabolic~Rate~(mu~mol ~O[2]~ min^-1~g^-1))) +
  scale_color_manual(values = c("black", "royalblue")) +
  theme_classic()
```
```{r}
## REFORMAT ABOVE FIGURE FOR PUBLICATION

AS.time.plot<-
  ggplot(data = exp.data, aes(x = Day, y = rate, fill = Bacteria)) +
  geom_boxplot(width =0.8, 
               outlier.shape = NA,
               lwd = 0.5, 
               color = "black") +
  geom_point(pch = 21, 
             size = 1.2, 
             stroke = 0.3, 
             width = 0.05,
             color = "black",
             position=position_jitterdodge()) +
  
    ggtitle("4. Metabolic Response to Acute Stress through Chronic Thermal Stress") +
  
  ylab(bquote(Metabolic~Rate~(mu~mol ~O[2]~ min^-1~g^-1))) +
  scale_fill_manual("", values = c("#EACB2B", "#3B99B1")) +
#  scale_x_discrete("", limits = c("EC", "SW"), labels = c("+ EC (Acute Stress)", "- EC (Control)")) +
#  scale_y_continuous(limits = c(0, 0.38), breaks = seq(0, 0.38, by = 0.05)) +
 scale_y_continuous(limits = c(0, 0.075), breaks = seq(0, 0.075, by = 0.025)) + # for full figure incl outlier

  theme_bw()+
  theme(legend.position= "right",
        axis.ticks=element_line(size=0.1),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_rect(colour = "black", size = 0.2),
        axis.line = element_line(colour = "black", size = 0.2),
        strip.background = element_blank(),
        axis.text = element_text(size=9),
        axis.title.y = element_text(size=9)) 

AS.time.plot
```

```{r}
## This is just a place to experiment with the above figure to determine what style of graph makes the most sense to portray this time series data

AS.time.test<-
  ggplot(data = exp.data, aes(x = Day, y = rate, fill = Bacteria)) +
  
#  geom_boxplot(width =0.8, 
 #              outlier.shape = NA,
  #             lwd = 0.5, 
   #            color = "black") +
  geom_point(pch = 21, 
             size = 1.2, 
             stroke = 0.3, 
             width = 0.05,
             color = "black",
             position=position_jitterdodge()) +
 # geom_line(data = temp.sum3, aes(x = Day, 
 #          y = rate, 
 #          col = Bacteria,
 #          group = Bacteria)) +
  
#    ggtitle("4. Metabolic Response to Acute Stress through Chronic Thermal Stress") +
  
#  ylab(bquote(Metabolic~Rate~(mu~mol ~O[2]~ min^-1~g^-1))) +
#  scale_fill_manual("", values = c("#EACB2B", "#3B99B1")) +
#  scale_x_discrete("", limits = c("EC", "SW"), labels = c("+ EC (Acute Stress)", "- EC (Control)")) +
#  scale_y_continuous(limits = c(0, 0.38), breaks = seq(0, 0.38, by = 0.05)) + #for full figure incl outlier
# scale_y_continuous(limits = c(0, 0.075), breaks = seq(0, 0.075, by = 0.025)) + 

  theme_bw()+
  theme(legend.position= "right",
        axis.ticks=element_line(size=0.1),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_rect(colour = "black", size = 0.2),
        axis.line = element_line(colour = "black", size = 0.2),
        strip.background = element_blank(),
        axis.text = element_text(size=9),
        axis.title.y = element_text(size=9)) 

AS.time.test
```

```{r}
# ADDED 2/24/2025

# Looking to determine if symbiosis affects MR over time at elevated temperatures
# Create linear model with 
temp.lmertest <- lmer(rate ~ Bacteria * Day * Sym.state + (1|B.TAG), data = exp.data)
summary(temp.lmertest)

# ANOVA model comparison
null <- lmer(rate ~ 1 + (1| B.TAG), data = exp.data) # null for this data set
Qtest <- lmer(rate ~ Bacteria + (1|B.TAG), data = exp.data) # model without day for this data set
temp.lmertest.aov <- anova(null, Qtest, temp.lmertest) #model comparison 
  
# Emmeans posthoc
temp.lmertest <- lmer(rate ~ Bacteria * as.factor(Day) * Sym.state + (1|B.TAG), data = exp.data)
temp.meanstest <- emmeans(temp.lmertest, list(pairwise~"Bacteria:Day:Sym.state"))
temp.meanstest # view tukey output
```

```{r}
# Summarize means within experimental controls
phen.time.means <- summarySE(exp.data, measurevar = "rate", groupvars = c("Day", "Bacteria", "Sym.state"))

# Plot 
ggplot(data = phen.time.means, 
                     aes(x = Day, 
                         y = rate, 
                         col = Sym.state, 
                         group = interaction(Bacteria, Sym.state))) +
  geom_line(aes(color = Sym.state, linetype = Bacteria)) +
  geom_point() + #aes(color = Sym.state, shape = Bacteria)) +
  geom_errorbar(aes(ymin=rate-se, ymax=rate+se), width=0.2, size = 1) +
  labs(x = "\nDay", 
       y = bquote(Metabolic~Rate~(mu~mol ~O[2]~ min^-1~g^-1)))+
  theme_classic() +
  scale_color_manual(values = c("tan", "coral4")) 
```

```{r}
## REFORMAT ABOVE FIGURE FOR PUBLICATION

AS.time.phenotype.plot<-
  ggplot(data = exp.data, 
                     aes(x = Day, 
                         y = rate,
                        col = Sym.state:Bacteria)) +
                        # group = interaction(Bacteria, Sym.state))) +
  geom_boxplot(aes(col = Sym.state:Bacteria, fill = Sym.state:Bacteria),
               color = "black",
               outlier.shape = NA) +
  geom_point(aes(fill = Sym.state:Bacteria, 
                 shape = Bacteria), 
             size = 1.2, 
             stroke = 0.3, 
             width = 0.05,
             color = "black",
             position=position_jitterdodge()) +
  scale_shape_manual(values = c(21,23)) +
  
  ggtitle("5. Effect of Phenotype on MR Over Time in Chronic Thermal Stress") +
  
  ylab(bquote(Metabolic~Rate~(mu~mol ~O[2]~ min^-1~g^-1))) +
  scale_fill_manual("", values = c("tan", "tan", "coral4", "coral4")) +
#  scale_x_discrete("", limits = c("EC", "SW"), labels = c("+ EC (Acute Stress)", "- EC (Control)")) +
# scale_y_continuous(limits = c(0, 0.38), breaks = seq(0, 0.38, by = 0.05)) +
 scale_y_continuous(limits = c(0, 0.075), breaks = seq(0, 0.075, by = 0.025)) + # for full figure incl outlier

  theme_bw()+
  theme(legend.position= "right",
        axis.ticks=element_line(size=0.1),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_rect(colour = "black", size = 0.2),
        axis.line = element_line(colour = "black", size = 0.2),
        strip.background = element_blank(),
        axis.text = element_text(size=9),
        axis.title.y = element_text(size=9)) 

AS.time.phenotype.plot
```


```{r}
# Run lmer mixed effects models on experimental stressors with Polyp ID as a random effect to account for repeat measures

for (s in 1:length(stressors)) {
  
  tmp.data <- exp.data
  tmp.data$Day <- as.numeric(tmp.data$Day)
  s.lmer3 <- lmer(as.formula(paste("rate ~", paste(stressors[s]), "* Bacteria * Day + (1|B.TAG)")), data = tmp.data) 
  print(paste(stressors[s],"Q3 LMER sum:", sep = " "))
  print(summary(s.lmer3)) 
  
#  sink(paste("/Users/speroffs/Desktop/A.Poculata-Multiple-stressors-thesis-analysis-/Respiration/ModelOutputs/", 
#             paste(stressors[s],"Q3 LMER sum.txt", sep = " "), sep = ""))
#  print(summary(s.lmer3))
#  sink()
  
  # Posthoc ANOVA to compare model to the null
  null <- lmer(rate ~ 1 + (1| B.TAG), data = tmp.data) # null model without effects using experimental treatments only 
  Q1 <- lmer(as.formula(paste("rate~",paste(stressors[s]), "+ (1|B.TAG)")), data = tmp.data) 
  Q2 <- lmer(as.formula(paste("rate~",paste(stressors[s]), "* Bacteria + (1|B.TAG)")), data = tmp.data)
  
  s.lmer3.aov <- anova(null, Q1, Q2, s.lmer3) # model comparison 
  print(paste(stressors[s],"Q3 ANOVA sum:", sep = " ")) # name the summary output 
  print(s.lmer3.aov) 
  
#  sink(paste("/Users/speroffs/Desktop/A.Poculata-Multiple-stressors-thesis-analysis-/Respiration/ModelOutputs/", 
#             paste(stressors[s],"Q3 ANOVA sum.txt", sep = " "), sep = "")) # save anova summary as txt
#  print(s.lmer3.aov)
#  sink()
}
```
```{r}
# emmeans post hoc day as factor
for (s in 1:length(stressors)) {
  
  tmp.data <- exp.data
  tmp.data$Day <- as.factor(tmp.data$Day)
  s.lmer3 <- lmer(as.formula(paste("rate ~", paste(stressors[s]), "* Bacteria * Day + (1|B.TAG)")), data = tmp.data) 

# Emmmeans posthoc test 
  s.lmer3.means <- emmeans(s.lmer3, as.formula(paste("list(pairwise)~",stressors[s],":Bacteria:Day")))
  print(paste(stressors[s],"Q3 EMMEANS sum:", sep = " "))
  print(summary(s.lmer3.means))
  
  
#  sink(paste("/Users/speroffs/Desktop/A.Poculata-Multiple-stressors-thesis-analysis-/Respiration/ModelOutputs/", 
#             paste(stressors[s],"Q3 EMMEANS sum.txt", sep = " "), sep = ""))
#  print(summary(s.lmer3.means))
#  sink()
}
```

```{r}
# Summarize by Plastic and bacteria over time
plastic.sum3 <- summarySE(data, measurevar = "rate", groupvars = c("Plastic", "Day", "Bacteria"))

# Plot 
ggplot(plastic.sum3, 
       aes(x = Day, 
           y = rate, 
           col = Plastic, 
           group = Plastic)) +
  geom_line() +
  geom_point() +
  
  facet_wrap(vars(Bacteria)) +
  geom_errorbar(aes(ymin=rate-se, ymax=rate+se), width=0.2, size = 1) +
  labs(x = "\nDay", 
       y = bquote(Metabolic~Rate~(mu~mol ~O[2]~ min^-1~g^-1))) +
  scale_color_manual(values = c("black", "darkgreen")) +
  theme_classic()
```

```{r}
# Summarize by Light and bacteria over time
light.sum3 <- summarySE(data, measurevar = "rate", groupvars = c("Light", "Day", "Bacteria"))

# Plot 
ggplot(light.sum3, 
       aes(x = Day, 
           y = rate, 
           col = Light, 
           group = Light)) +
  geom_line() +
  geom_point() +
  
  facet_wrap(vars(Bacteria)) +
  geom_errorbar(aes(ymin=rate-se, ymax=rate+se), width=0.2, size = 1) +
  labs(x = "\nDay", 
       y = bquote(Metabolic~Rate~(mu~mol ~O[2]~ min^-1~g^-1))) +
  scale_color_manual(values = c("black", "goldenrod")) +
  theme_classic()
```

```{r}
# Summarize by Food and bacteria over time
food.sum3 <- summarySE(data, measurevar = "rate", groupvars = c("Food", "Day", "Bacteria"))

# Plot 
ggplot(food.sum3, 
       aes(x = Day, 
           y = rate, 
           col = Food, 
           group = Food)) +
  geom_line() +
  geom_point() +
  
  facet_wrap(vars(Bacteria)) +
  geom_errorbar(aes(ymin=rate-se, ymax=rate+se), width=0.2, size = 1) +
  labs(x = "\nDay", 
       y = bquote(Metabolic~Rate~(mu~mol ~O[2]~ min^-1~g^-1))) +
  scale_color_manual(values = c("orangered4", "black")) +
  theme_classic()
```

```{r}
# Summarize by phenotype and bacteria over time
phenotype.sum3 <- summarySE(data, measurevar = "rate", groupvars = c("Sym.state", "Day", "Bacteria"))

# Plot 
ggplot(phenotype.sum3, 
       aes(x = Day, 
           y = rate, 
           col = Sym.state, 
           group = Sym.state)) +
  geom_line() +
  geom_point() +
  
  facet_wrap(vars(Bacteria)) +
  geom_errorbar(aes(ymin=rate-se, ymax=rate+se), width=0.2, size = 1) +
  labs(x = "\nDay", 
       y = bquote(Metabolic~Rate~(mu~mol ~O[2]~ min^-1~g^-1))) +
  scale_color_manual(values = c("tan", "coral4")) +
  theme_classic()
```

#########################################################################################################################
#
#                           Question 4. Is there a differential response to the stressor by phenotype / 
#                            What is the effect of phenotype exposed to this stressor on metabolic rate?
#
#########################################################################################################################

```{r}
# Run lm for temperature at day 22
temp.lm4 <- lm(Lograte ~ Sym.state * Temperature, data = temp22.data)
summary(temp.lm4)

# Tukey post hoc 
temp.aov4 <- aov(Lograte ~ Sym.state * Temperature, data = temp22.data) # for tukey test
temp.tukey4 <- TukeyHSD(temp.aov4, which = 'Sym.state:Temperature')
temp.tukey4 # view tukey output

```

# Visualize temperature
```{r}
# Summarize by Temperature 
temperature.sum4 <- summarySE(temp22.data, measurevar = "rate", groupvars = c("Temperature","Sym.state"))

# Plot
ggplot(data = temperature.sum4,
       aes(x = Temperature,
           y = rate, 
           col = Sym.state)) +
   
  geom_point(size = 2) +
  geom_line() +
  geom_errorbar(aes(ymin=rate-se, ymax=rate+se), width=0.1, size = 1.2) +
  scale_color_manual(name = "",
                     labels = c("Aposymbiotic", "Symbiotic"),
                     values = c("tan","coral4")) +

  scale_y_continuous(name = "", limits = c(0, 0.052), breaks = seq(0.0, 0.05, by = 0.01)) +
  xlab("")+
  ggtitle("") +

  theme_classic(base_size=16) +
  theme(legend.position = c(0.75, 0.9),
        legend.title = element_blank(),
        legend.text = element_text(size = 12),
        plot.title = element_text(vjust = 1.1, size = 18, face="bold"))
```

```{r}
# Create stressor value that excludes phenotype
stressors2 <- c("Plastic", "Light", "Food")
```
```{r}
# Run lmer mixed effects models on experimental stressors with Polyp ID as a random effect to account for repeat measures 
for (s in 1:length(stressors2)) {

  s.lmer4 <- lmer(as.formula(paste("Lograte ~ Sym.state *", paste(stressors2[s]), "+ (1|B.TAG)")), data = exp.data) 
  print(paste(stressors2[s],"Q4 LMER sum:", sep = " "))
  print(summary(s.lmer4)) 
  
#  sink(paste("/Users/speroffs/Desktop/A.Poculata-Multiple-stressors-thesis-analysis-/Respiration/ModelOutputs/", 
#             paste(stressors2[s],"Q4 LMER sum.txt", sep = " "), sep = ""))
#  print(summary(s.lmer4))
#  sink()
  
  # Posthoc ANOVA to compare model to the null
  null <- lmer(rate ~ 1 + (1| B.TAG), data = exp.data) # null model without effects using experimental treatments only 
  Q1 <- lmer(as.formula(paste("Lograte~",paste(stressors2[s]), "+ (1|B.TAG)")), data = exp.data) 
  
  s.lmer4.aov <- anova(null, Q1, s.lmer4) # model comparison 
  print(paste(stressors2[s],"Q4 ANOVA sum:", sep = " ")) # name the summary output 
  print(s.lmer4.aov) 
  
#  sink(paste("/Users/speroffs/Desktop/A.Poculata-Multiple-stressors-thesis-analysis-/Respiration/ModelOutputs/", 
#             paste(stressors2[s],"Q4 ANOVA sum.txt", sep = " "), sep = "")) # save anova summary as txt
#  print(s.lmer4.aov)
#  sink()
  
  # Emmmeans posthoc test 
  s.lmer4.means <- emmeans(s.lmer4, as.formula(paste("list(pairwise)~",stressors2[s],":Sym.state")))
  print(paste(stressors2[s],"Q4 EMMEANS sum:", sep = " "))
  print(summary(s.lmer4.means))
  
#  sink(paste("/Users/speroffs/Desktop/A.Poculata-Multiple-stressors-thesis-analysis-/Respiration/ModelOutputs/", 
#             paste(stressors2[s],"Q4 EMMEANS sum.txt", sep = " "), sep = ""))
#  print(summary(s.lmer4.means))
#  sink()
}
```

```{r}
# Summarize by plastic 
plastic.sum4 <- summarySE(exp.data, measurevar = "rate", groupvars = c("Plastic","Sym.state"))

# Plot
ggplot(data = plastic.sum4,
       aes(x = Plastic,
           y = rate, 
           col = Sym.state)) +
   
  geom_point(size = 2) +
  geom_line() +
  geom_errorbar(aes(ymin=rate-se, ymax=rate+se), width=0.1, size = 1.2) +
  scale_color_manual(name = "",
                     labels = c("Aposymbiotic", "Symbiotic"),
                     values = c("tan","coral4")) +
   scale_x_discrete(name = "", # remove labels for paneling 
                   limits = c("NoPlastic", "Plastic"),
                   labels = c("No Plastic", "Plastic")) +
  ylab(bquote(Metabolic~Rate~(mu~mol ~O[2]~ min^-1~g^-1))) +
  xlab("")+

  theme_classic(base_size=16) +
  theme(legend.position = "top",
        legend.title = element_blank(),
        legend.text = element_text(size = 12),
        plot.title = element_text(vjust = 1.1, size = 18, face="bold"))
```

```{r}
# Summarize by Light 
light.sum4 <- summarySE(exp.data, measurevar = "rate", groupvars = c("Light","Sym.state"))

# Plot
ggplot(data = light.sum4,
       aes(x = Light,
           y = rate, 
           col = Sym.state)) +
     geom_point(size = 2) +
  geom_line() +
  geom_errorbar(aes(ymin=rate-se, ymax=rate+se), width=0.1, size = 1.2) +
  scale_color_manual(name = "",
                     labels = c("Aposymbiotic", "Symbiotic"),
                     values = c("tan","coral4")) +
   
  ylab(bquote(Metabolic~Rate~(mu~mol ~O[2]~ min^-1~g^-1))) +
  xlab("")+

  theme_classic(base_size=16) +
  theme(legend.position = "top",
        legend.title = element_blank(),
        legend.text = element_text(size = 12),
        plot.title = element_text(vjust = 1.1, size = 18, face="bold"))
```

```{r}
# Summarize by Food 
food.sum4 <- summarySE(exp.data, measurevar = "rate", groupvars = c("Food","Sym.state"))

# Plot
ggplot(data = food.sum4,
       aes(x = Food,
           y = rate, 
           col = Sym.state)) +
     geom_point(size = 2) +
  geom_line() +
  geom_errorbar(aes(ymin=rate-se, ymax=rate+se), width=0.1, size = 1.2) +
  scale_color_manual(name = "",
                     labels = c("Aposymbiotic", "Symbiotic"),
                     values = c("tan","coral4")) +
  ylab(bquote(Metabolic~Rate~(mu~mol ~O[2]~ min^-1~g^-1))) +
  xlab("")+

  theme_classic(base_size=16) +
  theme(legend.position = "top",
        legend.title = element_blank(),
        legend.text = element_text(size = 12),
        plot.title = element_text(vjust = 1.1, size = 18, face="bold"))
```

#########################################################################################################################
#
#                Question 5. Is there a differential metabolic response to bacteria by plastic and phenotype /
#                  What is the effect of phenotype when exposed to the stressor and bacteria on metabolic rate? 
#
#########################################################################################################################

```{r}
# Run lm for tempurature at day 22
temp.lm5 <- lm(Lograte ~ Sym.state * Temperature * Bacteria, data = temp22.data)
summary(temp.lm5)

# Tukey post hoc 
temp.aov5 <- aov(Lograte ~ Sym.state * Temperature * Bacteria, data = temp22.data) # for tukey test
temp.tukey5 <- TukeyHSD(temp.aov5, which = 'Sym.state:Temperature:Bacteria')
temp.tukey5 # view tukey output
```

```{r}
# Does phenotype affect MR within the ambient temperature control?
amb.lm <- lm(Lograte ~ Sym.state * Bacteria, data = ctrl.data)
summary(amb.lm)

amb.aov <- aov(Lograte ~ Sym.state * Bacteria, data = ctrl.data)
summary(amb.aov)
amb.tukey <- TukeyHSD(amb.aov)
amb.tukey
```

```{r}
# Does phenotype affect MR within the elevated temperatures?
elev.lm <- lm(Lograte ~ Sym.state * Bacteria, data = exp.data)
summary(elev.lm)

elev.aov <- aov(Lograte ~ Sym.state * Bacteria, data = exp.data)
elev.tukey <- TukeyHSD(elev.aov, which = "Sym.state:Bacteria")
elev.tukey
```

# Visualize temperature
```{r}
# Summarize by temperature, phenotype, and bacteria
temperature.sum5 <- summarySE(temp22.data, measurevar = "rate", groupvars = c("Temperature","Sym.state","Bacteria"))

# Plot
temp.plot.B <-
ggplot(data = temperature.sum5,
       aes(x = Bacteria,
           y = rate, 
           col = Sym.state,
           group =Sym.state)) +
  geom_point(size = 2, position=position_dodge(0.1)) +
  geom_line()+
  geom_errorbar(aes(ymin=rate-se, ymax=rate+se), width=0.15, size = 1.2, position=position_dodge(0.1)) +
  
  scale_color_manual(labels = c("Aposymbiotic", "Symbiotic"),
                     values = c("tan", "coral4")) +
  scale_x_discrete(
      #name = "Acute stress challenge", 
      limits = c("EC", "SW"), labels = c("Acute", "Basal")) +
 # ylab(bquote(Metabolic~Rate~(mu~mol ~O[2]~ min^-1~g^-1))) +
    scale_y_continuous(limits = c(0, 0.075), breaks = seq(0, 0.075, by = 0.025)) +

  ylab("") +
  xlab("")+
  ggtitle("B") +
  facet_grid(~Temperature) +
  
    theme_classic(base_size=16) +
    theme(legend.position = c(0.75,0.88),
        legend.title = element_blank(),
        legend.text = element_text(size = 12),
       # legend.background = element_rect(fill='transparent'),
       # legend.box.background = element_rect(fill='transparent'),
        plot.title = element_text(vjust = 1.1, size = 18, face="bold"),
        plot.margin = margin(1, 1, 1, 1)) 
    #guides(color = guide_legend(direction = "horizontal"))      

temp.plot.B
```
```{r}
#ggsave(plot = resp.temp.phen.plot,
#       filename = "/Users/speroffs/Desktop/A.Poculata-Multiple-stressors-thesis-analysis-/Respiration/Plots/temp.plot.B.jpg", width = 6, height = 6, units = "in", dpi=300)
```

# Panel temp A and temp B
```{r}
temp.resp.panel <- ggarrange(temp.plot.A, temp.plot.B,
          nrow = 1, common.legend = FALSE, labels = NA)

temp.resp.panel <-
annotate_figure(temp.resp.panel, 
                bottom = text_grob("Acute Challenge", hjust = 0.3, vjust = -1, size = 18))

temp.resp.panel
```
```{r}
ggsave(plot = temp.resp.panel,
       filename = "/Users/speroffs/Desktop/A.Poculata-Multiple-stressors-thesis-analysis-/Respiration/Figures/temp.resp.panel.jpg", width = 8, height = 5, units = "in", dpi = 300)
```


```{r}
# Run lmer mixed effects models on experimental stressors with Polyp ID as a random effect to account for repeat measures

for (s in 1:length(stressors2)) {

  s.lmer5 <- lmer(as.formula(paste("Lograte ~ Sym.state *", paste(stressors2[s]), "* Bacteria + (1|B.TAG)")), data = exp.data) 
  print(paste(stressors2[s],"Q5 LMER sum:", sep = " "))
  print(summary(s.lmer5)) 
  
#  sink(paste("/Users/speroffs/Desktop/A.Poculata-Multiple-stressors-thesis-analysis-/Respiration/ModelOutputs/", 
#             paste(stressors2[s],"Q5 LMER sum.txt", sep = " "), sep = ""))
#  print(summary(s.lmer5))
#  sink()
  
  # Posthoc ANOVA to compare model to the null
  null <- lmer(rate ~ 1 + (1| B.TAG), data = exp.data) # null model without effects using experimental treatments only 
  Q1 <- lmer(as.formula(paste("Lograte~",paste(stressors2[s]), "+ (1|B.TAG)")), data = exp.data) 
  Q4 <- lmer(as.formula(paste("Lograte ~ Sym.state *", paste(stressors2[s]), "* (1|B.TAG)")), data = exp.data)
  
  s.lmer5.aov <- anova(null, Q1, Q4, s.lmer5) # model comparison 
  print(paste(stressors2[s],"Q5 ANOVA sum:", sep = " ")) # name the summary output 
  print(s.lmer5.aov) 
  
#  sink(paste("/Users/speroffs/Desktop/A.Poculata-Multiple-stressors-thesis-analysis-/Respiration/ModelOutputs/", 
#             paste(stressors2[s],"Q5 ANOVA sum.txt", sep = " "), sep = "")) # save anova summary as txt
#  print(s.lmer5.aov)
#  sink()
  
  # Emmmeans posthoc test 
  s.lmer5.means <- emmeans(s.lmer5, as.formula(paste("list(pairwise)~",stressors2[s],":Sym.state:Bacteria")))
  print(paste(stressors2[s],"Q5 EMMEANS sum:", sep = " "))
  print(summary(s.lmer5.means))
  
#  sink(paste("/Users/speroffs/Desktop/A.Poculata-Multiple-stressors-thesis-analysis-/Respiration/ModelOutputs/", 
#             paste(stressors2[s],"Q5 EMMEANS sum.txt", sep = " "), sep = ""))
#  print(summary(s.lmer5.means))
#  sink()
}
```

```{r}
# Summarize by plastic, phenotype, and bacteria
plastic.sum5 <- summarySE(exp.data, measurevar = "rate", groupvars = c("Plastic","Sym.state","Bacteria"))

# To re-label the facet strip labels 
plastic.labs <- list("NoPlastic" = "No Plastic", "Plastic" = "Plastic")
plastic_labeller <- function(variable,value){
  return(plastic.labs[value])
}

# Plot
plastic.plot.B <-
ggplot(data = plastic.sum5,
       aes(x = Bacteria,
           y = rate, 
           col = Sym.state,
           group = Sym.state)) +
  geom_point(size = 2, position=position_dodge(0.1)) +
  geom_line() +
  geom_errorbar(aes(ymin=rate-se, ymax=rate+se), width=0.15, size = 1.2, position=position_dodge(0.1)) +
  
  scale_color_manual(labels = c("Aposymbiotic", "Symbiotic"),
                     values = c("tan", "coral4")) +
  scale_x_discrete(limits = c("EC", "SW"), labels = c("Acute", "Basal")) +
  scale_y_continuous(limits = c(0, 0.05), breaks = seq(0, 0.05, by = 0.025)) +

  ylab("") +
  xlab("")+
  ggtitle("") +
  facet_grid(~Plastic, labeller = plastic_labeller) +
  
    theme_classic(base_size=16) +
    theme(legend.position = "none",
        legend.title = element_blank(),
        legend.text = element_text(size = 12)) 
plastic.plot.B
```

```{r}
# Summarize by light, phenotype, and bacteria
light.sum5 <- summarySE(exp.data, measurevar = "rate", groupvars = c("Light","Sym.state","Bacteria"))

# Plot
light.plot.B <-
ggplot(data = light.sum5,
       aes(x = Bacteria,
           y = rate, 
           col = Sym.state,
           group = Sym.state)) +
  geom_point(size = 2, position=position_dodge(0.1)) +
  geom_line() +
  geom_errorbar(aes(ymin=rate-se, ymax=rate+se), width=0.15, size = 1.2, position=position_dodge(0.1)) +
  
  scale_color_manual(labels = c("Aposymbiotic", "Symbiotic"),
                     values = c("tan", "coral4")) +
  scale_x_discrete(limits = c("EC", "SW"), labels = c("Acute", "Basal")) +
  scale_y_continuous(limits = c(0, 0.05), breaks = seq(0, 0.05, by = 0.025)) +

  ylab("") +
  xlab("")+
  ggtitle("") +
  facet_grid(~Light) +
  
    theme_classic(base_size=16) +
    theme(legend.position = "none",
        legend.title = element_blank(),
        legend.text = element_text(size = 12)) 
      
light.plot.B
```

```{r}
# Summarize by food, phenotype, and bacteria
food.sum5 <- summarySE(exp.data, measurevar = "rate", groupvars = c("Food","Sym.state","Bacteria"))

# Plot
food.plot.B <-
ggplot(data = food.sum5,
       aes(x = Bacteria,
           y = rate, 
           col = Sym.state,
           group = Sym.state)) +
  geom_point(size = 2, position=position_dodge(0.1)) +
  geom_line() +
  geom_errorbar(aes(ymin=rate-se, ymax=rate+se), width=0.15, size = 1.2, position=position_dodge(0.1)) +
  
  scale_color_manual(labels = c("Aposymbiotic", "Symbiotic"),
                     values = c("tan", "coral4")) +
  scale_x_discrete(limits = c("EC", "SW"), labels = c("Acute", "Basal")) +
  scale_y_continuous(limits = c(0, 0.05), breaks = seq(0, 0.05, by = 0.025)) +

  ylab("") +
  xlab("")+
  ggtitle("") +
  facet_grid(~Food) +
  
    theme_classic(base_size=16) +
    theme(legend.position = "none",
        legend.title = element_blank(),
        legend.text = element_text(size = 12)) 
food.plot.B
```

# Arrange temperature, plastic, light, and food plots
```{r}
stressor.panel2 <- ggarrange(temp.plot.B, ggplot()+theme_void(), 
                             plastic.plot.B, ggplot()+theme_void(), 
                             light.plot.B, ggplot()+theme_void(), 
                             food.plot.B,
                             heights = c(5, 0, 
                                         5, 0,
                                         5, 0,
                                         5),
                             ncol = 1, 
                             common.legend = TRUE) 
                             #legend = c(1,1)) 

stressor.panel.comb <- ggarrange(stressor.panel1, stressor.panel2, align = 'h')

stressor.panel.comb <- annotate_figure(stressor.panel.comb, 
                left = text_grob(bquote(Metabolic~Rate~(mu~mol ~O[2]~ min^-1~g^-1)), 
                                 rot = 90, vjust = 1, size = 18),
                bottom = text_grob("Acute Challenge", hjust = 0.5, size = 18))
```
```{r}
# Save stressor panel figure
ggsave(plot = stressor.panel.comb,
filename = "/Users/speroffs/Desktop/A.Poculata-Multiple-stressors-thesis-analysis-/Respiration/Figures/stressor.panel.comb.jpg", width = 8.5, height = 11, units = "in", dpi=300)
```



###########################################################################################################################
#
#          Question 6. Is there a differential metabolic response to bacteria by plastic and phenotype over time /
#            What is the effect of phenotype when exposed to the stressor and bacteria over time on metabolic rate?
#
###########################################################################################################################

# Is there an affect of just elevated temperature over time?
```{r}
# Use data for elevated temperatures
# Run lm for phenotype and bacteria over time at thermal stress
elev.dat$Day <- as.numeric(elev.dat$Day)
temp.lmer6 <- lmer(rate ~ Sym.state * Bacteria * Day + (1|B.TAG), data = elev.dat)
summary(temp.lmer6)

# Save output to ModelOutputs folder
sink(
  paste("/Users/speroffs/Desktop/A.Poculata-Multiple-stressors-thesis-analysis-/Respiration/ModelOutputs/", # path
        file = "Temperature Q6 LMER sum.txt")) # name txt
summary(temp.lmer6) # what to print
sink(file = NULL) 

# ANOVA model comparison
null <- lmer(rate ~ 1 + (1| B.TAG), data = elev.dat) # null for this data set
Q2 <- lmer(rate ~ Bacteria + (1|B.TAG), data = elev.dat) # model without day for this data set
Q5 <- lmer(rate ~ Sym.state * Bacteria +* (1|B.TAG), data = elev.dat)

temp.lmer6.aov <- anova(null, Q2, Q5, temp.lmer6) #model comparison 

# Save Tukey to ModelOutputs folder
sink(
  paste("/Users/speroffs/Desktop/A.Poculata-Multiple-stressors-thesis-analysis-/Respiration/ModelOutputs/", # path
        file = "Temperature Q6 ANOVA sum.txt")) # name txt
(temp.lmer6.aov) # what to print
sink(file = NULL)
  
# Emmeans posthoc
temp.lmer6.6 <- lmer(rate ~ Sym.state * Bacteria * as.factor(Day) + (1|B.TAG), data = elev.dat)
temp.means6 <- emmeans(temp.lmer6.6, list(pairwise~"Sym.state:Bacteria:Day"))
temp.means6 # view tukey output

# Save Tukey to ModelOutputs folder
sink(
  paste("/Users/speroffs/Desktop/A.Poculata-Multiple-stressors-thesis-analysis-/Respiration/ModelOutputs/", # path
        file = "Temperature Q6 EMMEANS sum.txt")) # name txt
(temp.means6) # what to print
sink(file = NULL)
```

```{r}
# Run lmer mixed effects models on experimental stressors with Polyp ID as a random effect to account for repeat measures 

for (s in 1:length(stressors2)) {
  
  tmp.data <- data
  tmp.data$Day <- as.numeric(tmp.data$Day)

  s.lmer6 <- lmer(as.formula(paste("rate ~ Sym.state *", paste(stressors2[s]), "* Bacteria * Day + (1|B.TAG)")), data = tmp.data) 
  print(paste(stressors2[s],"Q6 LMER sum:", sep = " "))
  print(summary(s.lmer6)) 
  
  sink(paste("/Users/speroffs/Desktop/A.Poculata-Multiple-stressors-thesis-analysis-/Respiration/ModelOutputs/", 
             paste(stressors2[s],"Q6 LMER sum.txt", sep = " "), sep = ""))
  print(summary(s.lmer6))
  sink()
  
  # Posthoc ANOVA to compare model to the null
  null <- lmer(rate ~ 1 + (1| B.TAG), data = data) # null model without effects using experimental treatments only 
  Q1 <- lmer(as.formula(paste("rate~",paste(stressors2[s]), "+ (1|B.TAG)")), data = tmp.data) 
  Q4 <- lmer(as.formula(paste("rate ~ Sym.state *", paste(stressors2[s]), "+ (1|B.TAG)")), data = tmp.data)
  Q5 <- lmer(as.formula(paste("rate ~ Sym.state *", paste(stressors2[s]), "*Bacteria + (1|B.TAG)")), data = tmp.data) 

  s.lmer6.aov <- anova(null, Q1, Q4, Q5, s.lmer6) # model comparison 
  print(paste(stressors2[s],"Q6 ANOVA sum:", sep = " ")) # name the summary output 
  print(s.lmer6.aov) 
  
  sink(paste("/Users/speroffs/Desktop/A.Poculata-Multiple-stressors-thesis-analysis-/Respiration/ModelOutputs/", 
             paste(stressors2[s],"Q6 ANOVA sum.txt", sep = " "), sep = "")) # save anova summary as txt
  print(s.lmer6.aov)
  sink()
}
```

```{r}
for (s in 1:length(stressors2)) {
  
  tmp.data <- data
  tmp.data$Day <- as.factor(tmp.data$Day)

  s.lmer6 <- lmer(as.formula(paste("rate ~ Sym.state *", paste(stressors2[s]), "* Bacteria * Day + (1|B.TAG)")), data = tmp.data) 
 
 # Emmmeans posthoc test 
  s.lmer6.means <- emmeans(s.lmer6, as.formula(paste("list(pairwise)~",stressors2[s],":Sym.state:Bacteria:Day")))
  print(paste(stressors2[s],"Q6 EMMEANS sum:", sep = " "))
  print(summary(s.lmer6.means))
  
  sink(paste("/Users/speroffs/Desktop/A.Poculata-Multiple-stressors-thesis-analysis-/Respiration/ModelOutputs/", 
             paste(stressors2[s],"Q6 EMMEANS sum.txt", sep = " "), sep = ""))
  print(summary(s.lmer6.means))
  sink()
}
```

```{r}
# Summarize by plastic, phenotype, and bacteria over time 
plastic.sum6 <- summarySE(data, measurevar = "rate", groupvars = c("Plastic","Sym.state","Bacteria", "Day"))

# Plot 
ggplot(plastic.sum6, 
                 aes(Day, 
                     rate, 
                     col = Sym.state, 
                     group = Sym.state)) +
  geom_line() +
  geom_point() +
  facet_grid(Plastic~Bacteria) +
  geom_errorbar(aes(ymin=rate-se, ymax=rate+se), width=0.2, size = 1) +
  labs(x = "\nDay", 
       y = expression(paste("Rate O2 Consumption [log(umol*min"^"-1"~"*g"^"-1"~")]")), 
      caption = "data represent mean +/- SEM; no significant differences between phenotype \n in each plastic/bacterial treatment group" ) +
  scale_color_manual(values = c("tan", "coral4")) + 
  theme_classic()
```

```{r}
# Summarize by light, phenotype, and bacteria over time 
light.sum6 <- summarySE(data, measurevar = "rate", groupvars = c("Light","Sym.state","Bacteria", "Day"))

# Plot 
ggplot(light.sum6, 
                 aes(Day, 
                     rate, 
                     col = Sym.state, 
                     group = Sym.state)) +
  geom_line() +
  geom_point() +
  facet_grid(Light~Bacteria) +
  geom_errorbar(aes(ymin=rate-se, ymax=rate+se), width=0.2, size = 1) +
  labs(x = "\nDay", 
       y = expression(paste("Rate O2 Consumption [log(umol*min"^"-1"~"*g"^"-1"~")]")), 
      caption = "data represent mean +/- SEM; no significant differences between phenotype \n in each plastic/bacterial treatment group" ) +
  scale_color_manual(values = c("tan", "coral4")) + 
  theme_classic()
```

```{r}
# Summarize by food, phenotype, and bacteria over time 
food.sum6 <- summarySE(data, measurevar = "rate", groupvars = c("Food","Sym.state","Bacteria", "Day"))

# Plot 
ggplot(food.sum6, 
                 aes(Day, 
                     rate, 
                     col = Sym.state, 
                     group = Sym.state)) +
  geom_line() +
  geom_point() +
  facet_grid(Food~Bacteria) +
  geom_errorbar(aes(ymin=rate-se, ymax=rate+se), width=0.2, size = 1) +
  labs(x = "\nDay", 
       y = expression(paste("Rate O2 Consumption [log(umol*min"^"-1"~"*g"^"-1"~")]")), 
      caption = "data represent mean +/- SEM; no significant differences between phenotype \n in each plastic/bacterial treatment group" ) +
  scale_color_manual(values = c("tan", "coral4")) + 
  theme_classic()
```

```{r}
# Summarize by phenotype and bacteria over time 
temp.sum6 <- summarySE(elev.dat, measurevar = "rate", groupvars = c("Sym.state","Bacteria", "Day"))

# Plot 
ggplot(temp.sum6, 
                 aes(Day, 
                     rate, 
                     col = Sym.state, 
                     group = Sym.state)) +
  geom_line() +
  geom_point() +
  ggtitle("Elevated Temperature") +
  facet_wrap(~Bacteria) +
  geom_errorbar(aes(ymin=rate-se, ymax=rate+se), width=0.2, size = 1) +
  labs(x = "\nDay", 
       y = expression(paste("Rate O2 Consumption [log(umol*min"^"-1"~"*g"^"-1"~")]")), 
      caption = "data represent mean +/- SEM; no significant differences between phenotype \n in each plastic/bacterial treatment group" ) +
  scale_color_manual(values = c("tan", "coral4")) + 
  theme_classic()
```

###########################################################################################################################
#
#                                       The impact of Genotype on response to E. Coli
#
###########################################################################################################################

```{r}
# Libraries
library(openxlsx)
library(pivottabler)

# Load metadata with genotype data 
id.data <- read.csv("~/Desktop/A.Poculata-Multiple-stressors-thesis-analysis-/Growth/Full_ ID Metadata - *Frag metadata (xrack&control).csv", header = TRUE)
```

```{r}
# Add Colony values to 'data' dataframe by B.TAG

# Select variables from original data to keep
id.data2 <- id.data %>%
  select(Colony, B.TAG) 

# add variables to new df based on ID
col.data <- left_join(id.data2, data, by = "B.TAG")

# Remove NAs
col.data <- col.data[complete.cases(col.data),]
```

# Question 1. Does genotype affect metabolic rate? 
```{r}
# Run lmer with B.tag ID as a random effect
col.lmer <- lmer(rate ~ Colony + (1|B.TAG), data=col.data)
summary(col.lmer)# Colonies A21, S20, S21 are standout
```
```{r}
# Separate apo and sym phenotypes 
apo.col.data <- filter(col.data, Sym.state == "apo")
sym.col.data <- filter(col.data, Sym.state == "sym")
```
```{r}
# summarize by phenotype
apo.sum1 <- summarySE(apo.col.data, measurevar = "rate", groupvars = c("Colony", "Sym.state"))
sym.sum1 <- summarySE(sym.col.data, measurevar = "rate", groupvars = c("Colony",  "Sym.state"))

#Re-level colonies in order 
apo.sum1$Colony <- factor(apo.sum1$Colony , levels = c("A1", "A2", "A3", "A4", "A5", "A6", "A7",
                                                       "A8", "A9", "A10", "A11", "A12", "A13", "A14",
                                                       "A15", "A16", "A18", "A19", "A20", "A21", "A22",
                                                       "A23", "A24", "A25", "M1"))
sym.sum1$Colony <- factor(sym.sum1$Colony , levels = c("S4", "S5", "S6", "S7", "S8","S9", "S10", "S11", 
                                                       "S12", "S13", "S14", "S15", "S16", "S17", "S18",
                                                       "S19", "S20", "S21", "S22", "S23", "S24", "S25",
                                                       "S26", "S27", "S28", "S29", "S30"))
```
```{r}
# plot apo
apo.plot <- ggplot(data = apo.sum1,
                   aes(x = Colony, 
                       y = rate, 
                       color = Sym.state)) +
    geom_point() +
    geom_errorbar(aes(ymin=rate-se, ymax=rate+se), width=0.1, size = 1) +
    scale_color_manual(values = "tan") +
    theme_classic()

# plot sym 
sym.plot <- ggplot(data = sym.sum1,
                   aes(x = Colony,
                       y = rate,
                       color = Sym.state)) +
  geom_point() + 
  geom_errorbar(aes(ymin=rate-se, ymax=rate+se), width=0.1, size = 1) +
  scale_color_manual(values = "coral4") +
  theme_classic()

library(patchwork)
sym.plot + apo.plot + plot_layout(ncol=1)
```

# Question 2. Does genotype affect metabolic response to e.coli

```{r}
# LMER with B.Tag as random effect 
col.lmer2 <- lmer(rate ~ Colony * Bacteria + (1|B.TAG), data = col.data)
summary(col.lmer2) #A24, S20, S6
```
```{r}
col.emm <- emmeans(col.lmer2, list(pairwise~'Colony:Bacteria'))
colony.contrasts <- as.data.frame(col.emm$`pairwise differences of Colony, Bacteria`)
#colony.contrasts <- filter(colony.contrasts, p.value <= 0.05)

# How do I determine if genotype affects the response to e.coli? If response MR is not different in EC vs SW for a particular colony does that mean it affects the resilience? 
```

group_by(Bacteria)

pairwise: Colony~Treatment

```{r}
install.packages("groupedstats")
remotes::install_github("IndrajeetPatil/groupedstats")

groupedstats::grouped_lmer(
  data = col.data,
  formula = (rate ~ Colony + Bacteria + (1|B.TAG)),
  grouping.vars = Colony,
  REML = FALSE,
  tidy.args = list(effects = "fixed", conf.int = TRUE, conf.level = 0.95),
  output = "tidy"
)
```


```{r}
# summarize by phenotype
apo.sum2 <- summarySE(apo.col.data, measurevar = "rate", groupvars = c("Colony", "Sym.state", "Bacteria"))
sym.sum2 <- summarySE(sym.col.data, measurevar = "rate", groupvars = c("Colony", "Sym.state", "Bacteria"))

#Re-level colonies in order 
apo.sum2$Colony <- factor(apo.sum2$Colony , levels = c("A1", "A2", "A3", "A4", "A5", "A6", "A7",
                                                       "A8", "A9", "A10", "A11", "A12", "A13", "A14",
                                                       "A15", "A16", "A18", "A19", "A20", "A21", "A22",
                                                       "A23", "A24", "A25", "M1"))
sym.sum2$Colony <- factor(sym.sum2$Colony , levels = c("S4", "S5", "S6", "S7", "S8","S9", "S10", "S11", 
                                                       "S12", "S13", "S14", "S15", "S16", "S17", "S18",
                                                       "S19", "S20", "S21", "S22", "S23", "S24", "S25",
                                                       "S26", "S27", "S28", "S29", "S30"))
```
```{r}
# plot apo
apo.plot2 <- ggplot(data = apo.sum2,
                   aes(x = Bacteria, 
                       y = rate, 
                       color = Colony)) +
    geom_point() +
    geom_errorbar(aes(ymin=rate-se, ymax=rate+se), width=0.1, size = 1) +
    #scale_color_manual(values = "tan") +
    facet_wrap(~Colony, ncol=6) +
    ggtitle("Symbiotic") +
    theme_classic() +
    theme(legend.position = "none") 


# plot sym 
sym.plot2 <- ggplot(data = sym.sum2,
                   aes(x = Colony,
                       y = rate,
                       color = Colony)) +
  geom_point() + 
  geom_errorbar(aes(ymin=rate-se, ymax=rate+se), width=0.1, size = 1) +
  #scale_color_manual(values = "coral4") +
  facet_grid(~Bacteria) +
  ggtitle("Aposymbiotic") +
  theme(legend.position = "none") +
  theme_classic()

#library(patchwork)
sym.plot2 + apo.plot2 + plot_layout(ncol=1)
```

## Draw heatmap to show the average metabolic rate of each colony across all treatmets in response to E. coli and saltwater 

```{r}
# Summarize average rate by treatment, colony, and bacteria
col.rate <- summarySE(col.data, measurevar = "rate", groupvars = c("Treatment", "Colony", "Bacteria"))
col.rate

#subset columns of interest
col.rate <- subset(col.rate, select = c("Treatment", "Colony", "rate", "N", "Bacteria"))
col.rate$rate <- round(col.rate$rate , 5) # round to 5 decimal places

# Re-order colonies 
col.rate$Colony <- factor(col.rate$Colony, levels = c("A1", "A2", "A3", "A4", "A5", "A6", "A7",
                                                      "A8", "A9", "A10", "A11", "A12", "A13", "A14",
                                                      "A15", "A16", "A18", "A19", "A20", "A21", "A22",
                                                      "A23", "A24", "A25", "M1",
                                                      "S4", "S5", "S6", "S7", "S8","S9", "S10", "S11",
                                                      "S12", "S13", "S14", "S15", "S16", "S17", "S18",
                                                      "S19", "S20", "S21", "S22", "S23", "S24", "S25",
                                                      "S26", "S27", "S28", "S29", "S30"))
```

```{r}
# Write summary data into a pivot table
pt2 <- PivotTable$new() # create pivot table 
pt2$addData(col.rate) # add dataframe 
pt2$addColumnDataGroups("Colony", addTotal=FALSE) # add column
pt2$addColumnDataGroups("Bacteria", addTotal=FALSE) # add subgroup within column 
pt2$addRowDataGroups("Treatment", addTotal=FALSE) # add rows
pt2$defineCalculation(calculationName="Rate", summariseExpression="mean(rate)") # summarize average rate
pt2$evaluatePivot() 

#summary(data$rate)
# apply the background-color styling based on the quantile distribution of rates
pt2$mapStyling(cells=pt2$allCells, styleProperty="background-color", 
              valueType="color", mapType="continuous",
              mappings=list(-8.2703, "#1A9641", # dark green (shallowest slope, most negative (log(absolute value)))
                            -5.3496, "#A6D96A",
                            -4.7683, "#FFFFBF", # yellow
                            -3.8248, "#FDAE61",
                            -0.9969, "#D7191C")) # red

# apply the color styling to cell text 
pt2$mapStyling(cells=pt2$allCells, styleProperty="color", 
              valueType="color", mapType="continuous",
              mappings=list(-8.2703, "#1A9641",
                            -5.3496, "#A6D96A",
                            -4.7683, "#FFFFBF",
                            -3.8248, "#FDAE61",
                            -0.9969, "#D7191C"))
pt2$renderPivot() # create table 
```
```{r}
# Export heatmap table to excel 
wb <- createWorkbook(creator = Sys.getenv("USERNAME"))
addWorksheet(wb, "Heatmap")
pt2$writeToExcelWorksheet(wb=wb, wsName="Heatmap", 
                         topRowNumber=1, leftMostColumnNumber=1, 
                         applyStyles=TRUE, mapStylesFromCSS=TRUE)
saveWorkbook(wb, file="Respiration Genotype Heatmap.xlsx", overwrite = TRUE)
```


###########################################################################################################################
#
#                             Mixed effects modeling of the additive and multiplicative impacts of 
#                                  stress treatments and biological factors on metabolic rate 
#
###########################################################################################################################

```{r}
# Start with a null model, including B.TAG as a random effect to account for repeat measures 
data$Day <- as.numeric(data$Day)
m0 <- lmer(Lograte ~ 1 + (1|B.TAG), data = data)
```

# Start by examining the manupulated chronic stressors first for all polyps (including ambient control)
```{r}
# Full stressor model 
mfull <- lmer(Lograte ~ Plastic + Light + Food + Temperature + (1|B.TAG), data = data)
summary(mfull)
```
```{r}
# Drop food
m1 <- lmer(Lograte ~ Plastic + Light + Temperature + (1|B.TAG), data = data)
summary(m1)
```
```{r}
# Drop plastic
m2 <- lmer(Lograte ~ Light + Temperature + (1|B.TAG), data = data)
summary(m2) 
```
```{r}
# drop temperature
m3 <- lmer(Lograte ~ Light + (1|B.TAG), data = data) ## LIGHT
summary(m3)
```
```{r}
AIC(m0, mfull, m1, m2, m3)
anova(m0, mfull, m1, m2, m3) 

## For all polyps, including ambient temperatures: Light influences MR !! (m3)
```

```{r}
library(sjstats)
library(sjPlot)
# plot model 3
m3 <- lmer(Lograte ~ Light + (1|B.TAG), data = data) ## LIGHT
l=plot_model(m3, 'pred', ci.lvl = 0.95, terms="Light")

l +
  theme_classic() +
xlab("Light")+
  ylab("Rate O2 Consumption (umol*min-1*g-1)")+
  ggtitle("lmer(Lograte ~ Light + (1|B.TAG), data = data)")+
  theme(axis.title.x = element_text(color="black", size=14, face="bold"),
axis.title.y = element_text(color="black", size=14, face="bold"))+
  theme(axis.text.x = element_text(size=14),
          axis.text.y = element_text(size=14))
```

# Let's now look at some models that include factors outside of our 4 stressors 
```{r}
# All stressors plus biological factors 
m4 <- lmer(Lograte ~ Plastic + Light + Food + Temperature + Sym.state + Day + Bacteria + (1|B.TAG), data = data)
summary(m4)
```
```{r}
m4.4 <- lmer(Lograte ~ Plastic + Light + Food + Temperature + Sym.state + Bacteria + (1|B.TAG) + (1|Day), data = data)
summary(m4.4)
anova(m4, m4.4) # seems like fitting day as a random effects makes the model fit better (lower AIC) score
```
```{r}
m5 <- lmer(Lograte ~ Plastic + Light + Temperature + Day + Sym.state + Bacteria + (1|B.TAG), data = data) #drop food
summary(m5)
m5.5 <- lmer(Lograte ~ Plastic + Light + Temperature + Sym.state + Bacteria + (1|B.TAG) + (1|Day), data = data) #drop food
summary(m5.5)
anova(m5, m5.5) # day as random effect
```
```{r}
m6 <- lmer(Lograte ~ Plastic + Light + Temperature  + Bacteria + (1|B.TAG) + (1|Day), data = data) #drop sym state
summary(m6)
```
```{r}
m7 <- lmer(Lograte ~ Light + Temperature + Bacteria + (1|B.TAG) + (1|Day), data = data) #drop plastic
summary(m7)
```
```{r}
AIC(m0, m4, m4.4, m5, m5.5, m6, m7)
anova(m0, m4, m4.4, m5, m5.5, m6, m7)
AIC(m7, m6) # yes 
# M7, with light, plastic, bacteria, and day as a random intercept has the lowest AIC score out of all of them 
```

```{r}
# plot model 7
m7 <- lmer(Lograte ~ Light + Temperature + Bacteria + (1|B.TAG) + (1|Day), data = data)
dat <- ggemmeans(m7, terms = c("Light", "Temperature", "Bacteria")) #

ggplot(dat, 
       aes(x = x, 
           y = predicted, # Log.rate
           colour = group)) + # Light
  
   geom_point(size=2) + 
  
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0.1) +
  
  labs(x = "Light", 
       y = "Rate O2 Consumption (umol*min-1*g-1)") +
  facet_grid(~facet) +
  ggtitle("lmer(Lograte ~ Light + Temperature + Bacteria + (1|B.TAG) + (1|Day), data = data)") +
  theme_classic() +
  theme(axis.title.x = element_text(color="black", size=12),
axis.title.y = element_text(color="black", size=12))+
  theme(axis.text.x = element_text(size=12),
          axis.text.y = element_text(size=12)) +
  scale_color_manual(values=c("blue", "red"))
```



## Now, let's run the stressors again, but just for the elevated temperature treatments
```{r}
m.null <- lmer(Lograte ~ 1 + (1|B.TAG), data = elev.dat)
summary(m.null)
```
```{r}
# Full elev model:
m.elev.full <- lmer(Lograte ~ Plastic + Light + Food + (1|B.TAG), data = elev.dat)
summary(m.elev.full)
```
```{r}
# drop food
m.elev.1 <- lmer(Lograte ~ Plastic + Light  + (1|B.TAG), data = elev.dat)
summary(m.elev.1)
```
```{r}
# drop plastic
m.elev.2 <- lmer(Lograte ~ Light  + (1|B.TAG), data = elev.dat) ## LIGHT
summary(m.elev.2)
```

```{r}
# plot model 2
m.elev.2 <- lmer(Lograte ~ Light  + (1|B.TAG), data = elev.dat) ## LIGHT
l2=plot_model(m.elev.2, 'pred', ci.lvl = 0.95, terms="Light")

l2 +
  theme_classic() +
xlab("Light")+
  ylab("Rate O2 Consumption (umol*min-1*g-1)")+
  ggtitle("lmer(Lograte ~ Light  + (1|B.TAG), data = elev.dat)")+
  theme(axis.title.x = element_text(color="black", size=14, face="bold"),
axis.title.y = element_text(color="black", size=14, face="bold"))+
  theme(axis.text.x = element_text(size=14),
          axis.text.y = element_text(size=14))
```

# And let's add in non-stressor factors 
```{r}
m.elev.3 <- lmer(Lograte ~ Plastic + Light + Food + Sym.state + Day + Bacteria + (1|B.TAG), data = elev.dat) # day as fixed
summary(m.elev.3)

m.elev.3.3 <- lmer(Lograte ~ Plastic + Light + Food + Sym.state + Bacteria + (1|B.TAG) + (1|Day), data = elev.dat) # day as random

anova(m.elev.3, m.elev.3.3)
AIC(m.elev.3, m.elev.3.3)
# day as random effect
```
```{r}
# drop sym state
m.elev.4 <- lmer(Lograte ~ Plastic + Light + Food + Bacteria + (1|B.TAG) + (1|Day), data = elev.dat)
summary(m.elev.4)
```
```{r}
# drop food
m.elev.5 <- lmer(Lograte ~ Plastic + Light + Bacteria + (1|B.TAG) + (1|Day), data = elev.dat)
summary(m.elev.5)
```
```{r}
# drop plasitc
m.elev.6 <- lmer(Lograte ~ Light + Bacteria + (1|B.TAG) + (1|Day), data = elev.dat) ## LIGHT still the only stressor
summary(m.elev.6)
```

```{r}
# plot model 6
m.elev.6 <- lmer(Lograte ~ Light + Bacteria + (1|B.TAG) + (1|Day), data = elev.dat) ## LIGHT still the only stressor
dat2 <- ggemmeans(m.elev.6, terms = c("Light", "Bacteria")) #

ggplot(dat2, 
       aes(x = x, 
           y = predicted, # Log.rate
           colour = group)) + # Light
  
   geom_point(size=2) + 
  
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0.1) +
  
  labs(x = "Light", 
       y = "Rate O2 Consumption (umol*min-1*g-1)") +
  ggtitle("lmer(Lograte ~ Light + Bacteria + (1|B.TAG) + (1|Day), data = elev.dat)") +
  theme_classic() +
  theme(axis.title.x = element_text(color="black", size=12),
axis.title.y = element_text(color="black", size=12))+
  theme(axis.text.x = element_text(size=12),
          axis.text.y = element_text(size=12)) +
  scale_color_manual(values=c("blue", "red"))
```

# look for interacting effects
```{r}
m.elev.6 <- lmer(Lograte ~ Plastic + Light + Day + Bacteria + 
                   Plastic*Light + Plastic*Day + Plastic*Bacteria +
                   Light*Day + Light*Bacteria + (1|B.TAG), data = elev.dat)
summary(m.elev.6)
```
```{r}
# drop plastic:bacteria
m.elev.7 <- lmer(Lograte ~ Plastic + Light + Day + Bacteria + 
                   Plastic*Light + Plastic*Day + 
                   Light*Day + Light*Bacteria + (1|B.TAG), data = elev.dat)
summary(m.elev.7)
```
```{r}
# drop plastic:day
m.elev.8 <- lmer(Lograte ~ Plastic + Light + Day + Bacteria + 
                   Plastic*Light + 
                   Light*Day + Light*Bacteria + (1|B.TAG), data = elev.dat)
summary(m.elev.8)
```
```{r}
# drop light:bacteria
m.elev.9 <- lmer(Lograte ~ Plastic + Light + Day + Bacteria + 
                   Plastic*Light + 
                   Light*Day + (1|B.TAG), data = elev.dat)
summary(m.elev.9)

# even though light*day & plastic*light are significant, there is a positive effect with the intercept (bad)
library(performance)
check_model(m.elev.9) # moderate collinearity with light, and light:day!
```
```{r}
# compare the light and day factors to see which fits best
m.9.light <- lmer(Lograte ~ Plastic + Light + Bacteria + Plastic*Light + (1|B.TAG), data = elev.dat)
m.9.day <- lmer(Lograte ~ Plastic + Day + Bacteria + Plastic*Light + (1|B.TAG), data = elev.dat)

anova(m.null, m.9.day, m.9.light)
AIC(m.9.day, m.9.light) # light is a better predictor than day, drop day from m9
```
```{r}
# is the model better with the interaction between light and plastic
m.elev.10 <- lmer(Lograte ~ Plastic + Light + Bacteria + (1|B.TAG), data = elev.dat)
summary(m.elev.10)

anova(m.9.light, m.elev.10) # lowest (+) AIC, m.elev.10
```
```{r}
check_model(m.elev.10)
```

```{r}
# plot model 10
m.elev.10 <- lmer(Lograte ~ Plastic + Light + Bacteria + (1|B.TAG), data = elev.dat)
dat3 <- ggemmeans(m.elev.10, terms = c("Plastic", "Light", "Bacteria")) #

ggplot(dat3, 
       aes(x = x, 
           y = predicted, # Log.rate
           colour = group)) + # Light
  
   geom_point(size=2) + 
  
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0.1) +
  
  labs(x = "Plastic", 
       y = "Rate O2 Consumption (umol*min-1*g-1)") +
  facet_grid(~facet) +
  ggtitle("lmer(Lograte ~ Plastic + Light + Bacteria + (1|B.TAG), data = elev.dat)") +
  theme_classic() +
  theme(axis.title.x = element_text(color="black", size=12),
axis.title.y = element_text(color="black", size=12))+
  theme(axis.text.x = element_text(size=12),
          axis.text.y = element_text(size=12)) +
  scale_color_manual(values=c("black", "goldenrod"))

```

## FIX HERE ##


# Now let's look at stressors, external factors, and possible interaction affects
```{r}
m8 <- lmer(rate ~ Plastic + Light + Food + Temperature + Sym.state + Day + Bacteria +
             Sym.state:Light + Sym.state:Day + Sym.state:Temperature + Sym.state:Temperature:Day +
             (1|B.TAG), data = data)
summary(m8)
```
```{r}
m9 <- lmer(rate ~ Plastic + Light + Food + Temperature + Sym.state + Day + Bacteria +
             Sym.state:Light + Sym.state:Temperature + Temperature:Day + Sym.state:Temperature:Day +
             (1|B.TAG), data = data) # drop sym state:day
summary(m9)
```
```{r}
m10 <- lmer(rate ~ Plastic + Light + Food + Temperature + Sym.state + Day + Bacteria +
             Sym.state:Light + Sym.state:Temperature + Temperature:Day + 
             (1|B.TAG), data = data) # drop sym state:temp:day
summary(m10)
```
```{r}
m11 <- lmer(rate ~ Plastic + Light + Food + Temperature + Sym.state + Day + Bacteria +
             Sym.state:Temperature + Temperature:Day + 
             (1|B.TAG), data = data) # drop light:sym.state
summary(m11)
```
```{r}
m12 <- lmer(rate ~ Plastic + Light + Food  + Sym.state + Day + Bacteria +
               Sym.state:Temperature + Temperature:Day + 
               (1|B.TAG), data = data) # drop temp
summary(m12)
```
```{r}
m13 <- lmer(rate ~ Plastic + Light  + Sym.state + Day + Bacteria +
             Sym.state:Temperature + Temperature:Day + 
             (1|B.TAG), data = data) # drop food
summary(m13)
```
```{r}
m14 <- lmer(rate ~ Light  + Sym.state + Day + Bacteria +
             Sym.state:Temperature  + 
             (1|B.TAG), data = data) # drop plastic
summary(m14)
```
```{r}
AIC(m7, m8, m9, m10, m11, m12, m13)
anova(m12, m13)

# M13 best out of this group

anova(m6, m13) 

# M13 significantly better, let's check the assumptions of our model to make sure we don't violate them 
```

```{r}
library(see)
check_model(m13) # High colinearity!
check_collinearity(m13) # Let's fit a model like m13 with either sym state or temperature to see which model fits best
```

```{r}
m14 <- lmer(rate ~ Light + Sym.state + Day + Bacteria + (1|B.TAG), data = data) # with sym
summary(m14)

m15 <- lmer(rate~ Light + Temperature + Day + Bacteria + (1|B.TAG), data = data) # with temp
summary(m15)

anova(m14, m15) # suggests m15, with temperature as best-fit model, turns out to be the same model at m6

# let's check our assumptions again 
check_model(m15)
```

```{r}
# Let's compare our additive model vs a multiplicative model 

m15 <- lmer(rate~ Light + Temperature + Day + Bacteria + (1|B.TAG), data = data) # additive
m16 <- lmer(rate~ Light * Temperature * Day * Bacteria + (1|B.TAG), data = data) # multiplicative 
summary(m16)
m17 <- lmer(rate ~ Light * Temperature * Day * Bacteria + Light*Day + Bacteria:Day + (1|B.TAG), data = data)
summary(m17)

anova(m15, m16, m17)
AIC(m15, m16)

# m15 best score
```

```{r}
# Let's go ahead and visualize our model starting with the individual terms

library(performance)
library(insight)
library(sjstats)
library(sjPlot)
library(effects)
library(ggplot2)

# plot model estimate
m <- lmer(rate ~ Light + Temperature + Day + Bacteria + (1|B.TAG), data = data, REML = TRUE)
```

```{r}
# plot light
l=plot_model(m, 'pred', ci.lvl = 0.95, terms="Light")

l +
  theme_classic() +
xlab("Light")+
  ylab("Rate O2 Consumption (umol*min-1*g-1)")+
  ggtitle("")+
  theme(axis.title.x = element_text(color="black", size=14, face="bold"),
axis.title.y = element_text(color="black", size=14, face="bold"))+
  theme(axis.text.x = element_text(size=14),
          axis.text.y = element_text(size=14))
```
```{r}
# plot temperature
t=plot_model(m, 'pred', ci.lvl = 0.95, terms="Temperature")

t +
  theme_classic() +
xlab("Temperature")+
  ylab("Rate O2 Consumption (umol*min-1*g-1)")+
  ggtitle("")+
  theme(axis.title.x = element_text(color="black", size=14, face="bold"),
axis.title.y = element_text(color="black", size=14, face="bold"))+
  theme(axis.text.x = element_text(size=14),
          axis.text.y = element_text(size=14))
```
```{r}
# plot day
d=plot_model(m, 'pred', ci.lvl = 0.95, terms="Day")

d +
  theme_classic() +
xlab("Day")+
  ylab("Rate O2 Consumption (umol*min-1*g-1)")+
  ggtitle("")+
  theme(axis.title.x = element_text(color="black", size=14, face="bold"),
axis.title.y = element_text(color="black", size=14, face="bold"))+
  theme(axis.text.x = element_text(size=14),
          axis.text.y = element_text(size=14))
```
```{r}
# plot bacteria
b=plot_model(m, 'pred', ci.lvl = 0.95, terms="Bacteria")

b +
  theme_classic() +
xlab("Bacterial Challenge")+
  ylab("Rate O2 Consumption (umol*min-1*g-1)")+
  ggtitle("")+
  theme(axis.title.x = element_text(color="black", size=14, face="bold"),
axis.title.y = element_text(color="black", size=14, face="bold"))+
  theme(axis.text.x = element_text(size=14),
          axis.text.y = element_text(size=14))
```

```{r}
# Plot interactions  
library(ggeffects)

# Interaction plot model 
int.m<-lmer(rate~Light*Temperature*Day*Bacteria+(1|B.TAG), data=data)
summary(int.m)

dat2 <- ggemmeans(int.m, terms = c("Temperature", "Light", "Day", "Bacteria")) #

ggplot(dat2, aes(facet,predicted, colour = group)) +
  geom_point(aes(shape = x)) +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0.3) +
  labs(x = "Day", y = "Rate O2 Consumption (umol*min-1*g-1)",
       color = "Light") +
  facet_grid(~panel) +
  ggtitle("") +
  theme_classic() +
  theme(axis.title.x = element_text(color="black", size=12),
axis.title.y = element_text(color="black", size=12))+
  theme(axis.text.x = element_text(size=12),
          axis.text.y = element_text(size=12)) +
  scale_color_manual(values=c("black", "goldenrod"))
```



```{r}
#libraries required
library(lme4)
library(sjPlot)

tab_model(m4, m4.4,               # models to table
          show.intercept = TRUE,  # show intercept value
          p.val = "kr",           # p value method for lmer models, kenward-rogers
          p.style = "numeric",
          show.df = FALSE,        # degrees freedom
          show.aic = TRUE,        # AIC score
          show.icc = FALSE,       # contrast correlation for mm  
          show.r2 = FALSE,
          show.stat = TRUE,
          show.ngroups = FALSE,
          show.loglik = TRUE,
          title = "To be day or not to be day")
          
```

###########################################################################################################################
#
#                                                 Format for merged metric datasheet
#
############################################################################################################################

```{r}
# format wide
wide.rate = data %>%
  select(B.TAG, Day, rate, Bacteria) %>%
  spread(Day, rate)
```
```{r}
# load in all.data.merged
all.data.merged <- read.csv("~/Desktop/A.Poculata-Multiple-stressors-thesis-analysis-/All.data.merged.csv", header=TRUE)
names(all.data.merged)
```

```{r}
# edit names of wide.mass
names(wide.rate)[names(wide.rate) == "B.TAG"] <- "BTag" 
names(wide.rate)[names(wide.rate) == "8"] <- "MR.day8" 
names(wide.rate)[names(wide.rate) == "15"] <- "MR.day15" 
names(wide.rate)[names(wide.rate) == "22"] <- "MR.day22" 
```

```{r}
# add wide.mass to all.data.merged
all.data.merged <- left_join(all.data.merged, wide.rate, by = "BTag")

all.data.merged <- all.data.merged %>%
  select(-"X")
```
```{r}
# save merged data as a csv
path <- "/Users/speroffs/Desktop/A.Poculata-Multiple-stressors-thesis-analysis-"
write.csv(all.data.merged, file.path(path, "All.data.merged.csv"))
```




## compile all rate.csv files into one df
```{r}
#library(readr)
#library(plyr)

#setwd("/Users/speroffs/Desktop/A.Poculata-Multiple-stressors-thesis-analysis-/Respiration/AllRateFiles")
#my.dir = "AllRateFiles"
#my.files =list.files(path=my.dir, pattern="*.csv", full.names=TRUE)

#test.csv = ldply(my.files, read_csv)

#Save for later: 

#go back through to add Treatment to all CSV files in AllRateFiles folder 
```














